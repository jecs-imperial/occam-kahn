'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var arrayUtil = require('./util/array'),
    Edge = require('./graph/edge'),
    Vertex = require('./graph/vertex'),
    RemainingEdges = require('./graph/remainingEdges');

var Graph = function () {
  function Graph(topologicallyOrderedVertices, remainingEdges) {
    _classCallCheck(this, Graph);

    this.topologicallyOrderedVertices = topologicallyOrderedVertices;
    this.remainingEdges = remainingEdges;
  }

  _createClass(Graph, [{
    key: 'getTopologicallyOrderedVertices',
    value: function getTopologicallyOrderedVertices() {
      return this.topologicallyOrderedVertices;
    }
  }, {
    key: 'getRemainingEdges',
    value: function getRemainingEdges() {
      return this.remainingEdges;
    }
  }, {
    key: 'areCyclesPresent',
    value: function areCyclesPresent() {
      return this.remainingEdges.areCyclesPresent();
    }
  }], [{
    key: 'fromVertexNamesAndEdges',
    value: function fromVertexNamesAndEdges(vertexNames, edges) {
      var vertexMap = vertexMapFromVertexNames(vertexNames),
          topologicallyOrderedVertices = topologicallyOrderedVerticesFromVertexMapAndEdges(vertexMap, edges),
          remainingEdges = new RemainingEdges(edges),
          graph = new Graph(topologicallyOrderedVertices, remainingEdges);

      return graph;
    }
  }, {
    key: 'fromVertexLiterals',
    value: function fromVertexLiterals(vertexLiterals) {
      var vertexMap = vertexMapFromVertexLiterals(vertexLiterals),
          edges = edgesFromVertexLiteralsAndVertexMap(vertexLiterals, vertexMap),
          topologicallyOrderedVertices = topologicallyOrderedVerticesFromVertexMapAndEdges(vertexMap, edges),
          remainingEdges = new RemainingEdges(edges),
          graph = new Graph(topologicallyOrderedVertices, remainingEdges);

      return graph;
    }
  }]);

  return Graph;
}();

module.exports = Graph;

function vertexMapFromVertexNames(vertexNames) {
  var vertexMap = {};

  vertexNames.forEach(function (vertexName) {
    var vertexExists = vertexMap.hasOwnProperty(vertexName);

    if (!vertexExists) {
      var vertex = Vertex.fromVertexName(vertexName);

      vertexMap[vertexName] = vertex;
    }
  });

  return vertexMap;
}

function vertexMapFromVertexLiterals(vertexLiterals) {
  var vertexMap = {};

  vertexLiterals.forEach(function (vertexLiteral) {
    var firstVertexLiteralElement = arrayUtil.first(vertexLiteral),
        vertexName = firstVertexLiteralElement,
        ///
    vertexExists = vertexMap.hasOwnProperty(vertexName);

    if (!vertexExists) {
      var vertex = Vertex.fromVertexName(vertexName);

      vertexMap[vertexName] = vertex;
    }

    var secondVertexLiteralElement = arrayUtil.second(vertexLiteral),
        ancestorVertexNames = secondVertexLiteralElement; ///

    ancestorVertexNames.forEach(function (ancestorVertexName) {
      var ancestorVertexExists = vertexMap.hasOwnProperty(ancestorVertexName);

      if (!ancestorVertexExists) {
        var ancestorVertex = Vertex.fromVertexName(ancestorVertexName);

        vertexMap[ancestorVertexName] = ancestorVertex;
      }
    });
  });

  return vertexMap;
}

function edgesFromVertexLiteralsAndVertexMap(vertexLiterals, vertexMap) {
  var edges = [];

  vertexLiterals.forEach(function (vertexLiteral) {
    var firstVertexLiteralElement = arrayUtil.first(vertexLiteral),
        secondVertexLiteralElement = arrayUtil.second(vertexLiteral),
        ancestorVertexNames = secondVertexLiteralElement,
        ///
    vertexName = firstVertexLiteralElement,
        ///
    vertex = vertexMap[vertexName];

    ancestorVertexNames.forEach(function (ancestorVertexName) {
      var ancestorVertex = vertexMap[ancestorVertexName],
          sourceVertex = ancestorVertex,
          ///
      targetVertex = vertex,
          ///
      edge = new Edge(sourceVertex, targetVertex),
          incomingEdge = edge,
          ///
      outgoingEdge = edge; ///

      edges.push(edge);

      sourceVertex.addOutgoingEdge(outgoingEdge);

      targetVertex.addIncomingEdge(incomingEdge);
    });
  });

  return edges;
}

function topologicallyOrderedVerticesFromVertexMapAndEdges(vertexMap, edges) {
  var topologicallyOrderedVertices = [];

  var startingVertices = startingVerticesFromVertexMap(vertexMap),
      removedEdges = [];

  var startingVerticesLength = startingVertices.length;

  var _loop = function _loop() {
    var startingVertex = startingVertices.pop(),
        topologicallyOrderedVertex = startingVertex; ///

    topologicallyOrderedVertices.push(topologicallyOrderedVertex);

    arrayUtil.backwardsForEach(edges, function (edge, index) {
      var sourceVertex = edge.getSourceVertex(),
          edgeStarting = sourceVertex === startingVertex; ///

      if (edgeStarting) {
        edges.splice(index, 1);

        var targetVertex = edge.getTargetVertex(),
            incomingEdge = edge,
            ///
        removedEdge = edge; ///

        targetVertex.removeIncomingEdge(incomingEdge);

        removedEdges.push(removedEdge);

        var targetVertexStarting = targetVertex.isStarting();

        if (targetVertexStarting) {
          var _startingVertex = targetVertex; ///

          startingVertices.push(_startingVertex);
        }
      }
    });

    startingVerticesLength = startingVertices.length;
  };

  while (startingVerticesLength > 0) {
    _loop();
  }

  var edgesLength = edges.length;

  if (edgesLength === 0) {
    removedEdges.forEach(function (removedEdge) {
      var targetVertex = removedEdge.getTargetVertex(),
          incomingEdge = removedEdge; ///

      targetVertex.addIncomingEdge(incomingEdge);
    });
  }

  return topologicallyOrderedVertices;
}

function startingVerticesFromVertexMap(vertexMap) {
  var vertexNames = Object.keys(vertexMap),
      startingVertices = vertexNames.reduce(function (startingVertices, vertexName) {
    var vertex = vertexMap[vertexName],
        vertexStarting = vertex.isStarting();

    if (vertexStarting) {
      var _startingVertex2 = vertex; ///

      startingVertices.push(_startingVertex2);
    }

    return startingVertices;
  }, []);

  return startingVertices;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9ncmFwaC5qcyJdLCJuYW1lcyI6WyJhcnJheVV0aWwiLCJyZXF1aXJlIiwiRWRnZSIsIlZlcnRleCIsIlJlbWFpbmluZ0VkZ2VzIiwiR3JhcGgiLCJ0b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRpY2VzIiwicmVtYWluaW5nRWRnZXMiLCJhcmVDeWNsZXNQcmVzZW50IiwidmVydGV4TmFtZXMiLCJlZGdlcyIsInZlcnRleE1hcCIsInZlcnRleE1hcEZyb21WZXJ0ZXhOYW1lcyIsInRvcG9sb2dpY2FsbHlPcmRlcmVkVmVydGljZXNGcm9tVmVydGV4TWFwQW5kRWRnZXMiLCJncmFwaCIsInZlcnRleExpdGVyYWxzIiwidmVydGV4TWFwRnJvbVZlcnRleExpdGVyYWxzIiwiZWRnZXNGcm9tVmVydGV4TGl0ZXJhbHNBbmRWZXJ0ZXhNYXAiLCJtb2R1bGUiLCJleHBvcnRzIiwiZm9yRWFjaCIsInZlcnRleE5hbWUiLCJ2ZXJ0ZXhFeGlzdHMiLCJoYXNPd25Qcm9wZXJ0eSIsInZlcnRleCIsImZyb21WZXJ0ZXhOYW1lIiwidmVydGV4TGl0ZXJhbCIsImZpcnN0VmVydGV4TGl0ZXJhbEVsZW1lbnQiLCJmaXJzdCIsInNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50Iiwic2Vjb25kIiwiYW5jZXN0b3JWZXJ0ZXhOYW1lcyIsImFuY2VzdG9yVmVydGV4TmFtZSIsImFuY2VzdG9yVmVydGV4RXhpc3RzIiwiYW5jZXN0b3JWZXJ0ZXgiLCJzb3VyY2VWZXJ0ZXgiLCJ0YXJnZXRWZXJ0ZXgiLCJlZGdlIiwiaW5jb21pbmdFZGdlIiwib3V0Z29pbmdFZGdlIiwicHVzaCIsImFkZE91dGdvaW5nRWRnZSIsImFkZEluY29taW5nRWRnZSIsInN0YXJ0aW5nVmVydGljZXMiLCJzdGFydGluZ1ZlcnRpY2VzRnJvbVZlcnRleE1hcCIsInJlbW92ZWRFZGdlcyIsInN0YXJ0aW5nVmVydGljZXNMZW5ndGgiLCJsZW5ndGgiLCJzdGFydGluZ1ZlcnRleCIsInBvcCIsInRvcG9sb2dpY2FsbHlPcmRlcmVkVmVydGV4IiwiYmFja3dhcmRzRm9yRWFjaCIsImluZGV4IiwiZ2V0U291cmNlVmVydGV4IiwiZWRnZVN0YXJ0aW5nIiwic3BsaWNlIiwiZ2V0VGFyZ2V0VmVydGV4IiwicmVtb3ZlZEVkZ2UiLCJyZW1vdmVJbmNvbWluZ0VkZ2UiLCJ0YXJnZXRWZXJ0ZXhTdGFydGluZyIsImlzU3RhcnRpbmciLCJlZGdlc0xlbmd0aCIsIk9iamVjdCIsImtleXMiLCJyZWR1Y2UiLCJ2ZXJ0ZXhTdGFydGluZyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBLElBQU1BLFlBQVlDLFFBQVEsY0FBUixDQUFsQjtBQUFBLElBQ01DLE9BQU9ELFFBQVEsY0FBUixDQURiO0FBQUEsSUFFTUUsU0FBU0YsUUFBUSxnQkFBUixDQUZmO0FBQUEsSUFHTUcsaUJBQWlCSCxRQUFRLHdCQUFSLENBSHZCOztJQUtNSSxLO0FBQ0osaUJBQWFDLDRCQUFiLEVBQTJDQyxjQUEzQyxFQUEyRDtBQUFBOztBQUN6RCxTQUFLRCw0QkFBTCxHQUFvQ0EsNEJBQXBDO0FBQ0EsU0FBS0MsY0FBTCxHQUFzQkEsY0FBdEI7QUFDRDs7OztzREFFaUM7QUFDaEMsYUFBTyxLQUFLRCw0QkFBWjtBQUNEOzs7d0NBRW1CO0FBQ2xCLGFBQU8sS0FBS0MsY0FBWjtBQUNEOzs7dUNBRWtCO0FBQUUsYUFBTyxLQUFLQSxjQUFMLENBQW9CQyxnQkFBcEIsRUFBUDtBQUFnRDs7OzRDQUV0Q0MsVyxFQUFhQyxLLEVBQU87QUFDakQsVUFBTUMsWUFBWUMseUJBQXlCSCxXQUF6QixDQUFsQjtBQUFBLFVBQ01ILCtCQUErQk8sa0RBQWtERixTQUFsRCxFQUE2REQsS0FBN0QsQ0FEckM7QUFBQSxVQUVNSCxpQkFBaUIsSUFBSUgsY0FBSixDQUFtQk0sS0FBbkIsQ0FGdkI7QUFBQSxVQUdNSSxRQUFRLElBQUlULEtBQUosQ0FBVUMsNEJBQVYsRUFBd0NDLGNBQXhDLENBSGQ7O0FBS0EsYUFBT08sS0FBUDtBQUNEOzs7dUNBRXlCQyxjLEVBQWdC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QUFQO0FBQ0QiLCJmaWxlIjoiZ3JhcGguanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IGFycmF5VXRpbCA9IHJlcXVpcmUoJy4vdXRpbC9hcnJheScpLFxuICAgICAgRWRnZSA9IHJlcXVpcmUoJy4vZ3JhcGgvZWRnZScpLFxuICAgICAgVmVydGV4ID0gcmVxdWlyZSgnLi9ncmFwaC92ZXJ0ZXgnKSxcbiAgICAgIFJlbWFpbmluZ0VkZ2VzID0gcmVxdWlyZSgnLi9ncmFwaC9yZW1haW5pbmdFZGdlcycpO1xuXG5jbGFzcyBHcmFwaCB7XG4gIGNvbnN0cnVjdG9yICh0b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRpY2VzLCByZW1haW5pbmdFZGdlcykge1xuICAgIHRoaXMudG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0aWNlcyA9IHRvcG9sb2dpY2FsbHlPcmRlcmVkVmVydGljZXM7XG4gICAgdGhpcy5yZW1haW5pbmdFZGdlcyA9IHJlbWFpbmluZ0VkZ2VzO1xuICB9XG5cbiAgZ2V0VG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0aWNlcygpIHtcbiAgICByZXR1cm4gdGhpcy50b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRpY2VzO1xuICB9XG5cbiAgZ2V0UmVtYWluaW5nRWRnZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMucmVtYWluaW5nRWRnZXM7XG4gIH1cblxuICBhcmVDeWNsZXNQcmVzZW50KCkgeyByZXR1cm4gdGhpcy5yZW1haW5pbmdFZGdlcy5hcmVDeWNsZXNQcmVzZW50KCk7IH1cblxuICBzdGF0aWMgZnJvbVZlcnRleE5hbWVzQW5kRWRnZXModmVydGV4TmFtZXMsIGVkZ2VzKSB7XG4gICAgY29uc3QgdmVydGV4TWFwID0gdmVydGV4TWFwRnJvbVZlcnRleE5hbWVzKHZlcnRleE5hbWVzKSxcbiAgICAgICAgICB0b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRpY2VzID0gdG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0aWNlc0Zyb21WZXJ0ZXhNYXBBbmRFZGdlcyh2ZXJ0ZXhNYXAsIGVkZ2VzKSxcbiAgICAgICAgICByZW1haW5pbmdFZGdlcyA9IG5ldyBSZW1haW5pbmdFZGdlcyhlZGdlcyksXG4gICAgICAgICAgZ3JhcGggPSBuZXcgR3JhcGgodG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0aWNlcywgcmVtYWluaW5nRWRnZXMpO1xuXG4gICAgcmV0dXJuIGdyYXBoO1xuICB9XG5cbiAgc3RhdGljIGZyb21WZXJ0ZXhMaXRlcmFscyh2ZXJ0ZXhMaXRlcmFscykge1xuICAgIGNvbnN0IHZlcnRleE1hcCA9IHZlcnRleE1hcEZyb21WZXJ0ZXhMaXRlcmFscyh2ZXJ0ZXhMaXRlcmFscyksXG4gICAgICAgICAgZWRnZXMgPSBlZGdlc0Zyb21WZXJ0ZXhMaXRlcmFsc0FuZFZlcnRleE1hcCh2ZXJ0ZXhMaXRlcmFscywgdmVydGV4TWFwKSxcbiAgICAgICAgICB0b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRpY2VzID0gdG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0aWNlc0Zyb21WZXJ0ZXhNYXBBbmRFZGdlcyh2ZXJ0ZXhNYXAsIGVkZ2VzKSxcbiAgICAgICAgICByZW1haW5pbmdFZGdlcyA9IG5ldyBSZW1haW5pbmdFZGdlcyhlZGdlcyksXG4gICAgICAgICAgZ3JhcGggPSBuZXcgR3JhcGgodG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0aWNlcywgcmVtYWluaW5nRWRnZXMpO1xuXG4gICAgcmV0dXJuIGdyYXBoO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gR3JhcGg7XG5cbmZ1bmN0aW9uIHZlcnRleE1hcEZyb21WZXJ0ZXhOYW1lcyh2ZXJ0ZXhOYW1lcykge1xuICBjb25zdCB2ZXJ0ZXhNYXAgPSB7fTtcblxuICB2ZXJ0ZXhOYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKHZlcnRleE5hbWUpIHtcbiAgICBjb25zdCB2ZXJ0ZXhFeGlzdHMgPSB2ZXJ0ZXhNYXAuaGFzT3duUHJvcGVydHkodmVydGV4TmFtZSk7XG5cbiAgICBpZiAoIXZlcnRleEV4aXN0cykge1xuICAgICAgY29uc3QgdmVydGV4ID0gVmVydGV4LmZyb21WZXJ0ZXhOYW1lKHZlcnRleE5hbWUpO1xuXG4gICAgICB2ZXJ0ZXhNYXBbdmVydGV4TmFtZV0gPSB2ZXJ0ZXg7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gdmVydGV4TWFwO1xufVxuXG5mdW5jdGlvbiB2ZXJ0ZXhNYXBGcm9tVmVydGV4TGl0ZXJhbHModmVydGV4TGl0ZXJhbHMpIHtcbiAgY29uc3QgdmVydGV4TWFwID0ge307XG5cbiAgdmVydGV4TGl0ZXJhbHMuZm9yRWFjaChmdW5jdGlvbih2ZXJ0ZXhMaXRlcmFsKSB7XG4gICAgY29uc3QgZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCA9IGFycmF5VXRpbC5maXJzdCh2ZXJ0ZXhMaXRlcmFsKSxcbiAgICAgICAgICB2ZXJ0ZXhOYW1lID0gZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCwgLy8vXG4gICAgICAgICAgdmVydGV4RXhpc3RzID0gdmVydGV4TWFwLmhhc093blByb3BlcnR5KHZlcnRleE5hbWUpO1xuXG4gICAgaWYgKCF2ZXJ0ZXhFeGlzdHMpIHtcbiAgICAgIGNvbnN0IHZlcnRleCA9IFZlcnRleC5mcm9tVmVydGV4TmFtZSh2ZXJ0ZXhOYW1lKTtcblxuICAgICAgdmVydGV4TWFwW3ZlcnRleE5hbWVdID0gdmVydGV4O1xuICAgIH1cblxuICAgIGNvbnN0IHNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50ID0gYXJyYXlVdGlsLnNlY29uZCh2ZXJ0ZXhMaXRlcmFsKSxcbiAgICAgICAgICBhbmNlc3RvclZlcnRleE5hbWVzID0gc2Vjb25kVmVydGV4TGl0ZXJhbEVsZW1lbnQ7IC8vL1xuXG4gICAgYW5jZXN0b3JWZXJ0ZXhOYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKGFuY2VzdG9yVmVydGV4TmFtZSkge1xuICAgICAgY29uc3QgYW5jZXN0b3JWZXJ0ZXhFeGlzdHMgPSB2ZXJ0ZXhNYXAuaGFzT3duUHJvcGVydHkoYW5jZXN0b3JWZXJ0ZXhOYW1lKTtcblxuICAgICAgaWYgKCFhbmNlc3RvclZlcnRleEV4aXN0cykge1xuICAgICAgICBjb25zdCBhbmNlc3RvclZlcnRleCA9IFZlcnRleC5mcm9tVmVydGV4TmFtZShhbmNlc3RvclZlcnRleE5hbWUpO1xuXG4gICAgICAgIHZlcnRleE1hcFthbmNlc3RvclZlcnRleE5hbWVdID0gYW5jZXN0b3JWZXJ0ZXg7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuXG4gIHJldHVybiB2ZXJ0ZXhNYXA7XG59XG5cbmZ1bmN0aW9uIGVkZ2VzRnJvbVZlcnRleExpdGVyYWxzQW5kVmVydGV4TWFwKHZlcnRleExpdGVyYWxzLCB2ZXJ0ZXhNYXApIHtcbiAgY29uc3QgZWRnZXMgPSBbXTtcblxuICB2ZXJ0ZXhMaXRlcmFscy5mb3JFYWNoKGZ1bmN0aW9uKHZlcnRleExpdGVyYWwpIHtcbiAgICBjb25zdCBmaXJzdFZlcnRleExpdGVyYWxFbGVtZW50ID0gYXJyYXlVdGlsLmZpcnN0KHZlcnRleExpdGVyYWwpLFxuICAgICAgICAgIHNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50ID0gYXJyYXlVdGlsLnNlY29uZCh2ZXJ0ZXhMaXRlcmFsKSxcbiAgICAgICAgICBhbmNlc3RvclZlcnRleE5hbWVzID0gc2Vjb25kVmVydGV4TGl0ZXJhbEVsZW1lbnQsIC8vL1xuICAgICAgICAgIHZlcnRleE5hbWUgPSBmaXJzdFZlcnRleExpdGVyYWxFbGVtZW50LCAvLy9cbiAgICAgICAgICB2ZXJ0ZXggPSB2ZXJ0ZXhNYXBbdmVydGV4TmFtZV07XG5cbiAgICBhbmNlc3RvclZlcnRleE5hbWVzLmZvckVhY2goZnVuY3Rpb24oYW5jZXN0b3JWZXJ0ZXhOYW1lKSB7XG4gICAgICBjb25zdCBhbmNlc3RvclZlcnRleCA9IHZlcnRleE1hcFthbmNlc3RvclZlcnRleE5hbWVdLFxuICAgICAgICAgICAgc291cmNlVmVydGV4ID0gYW5jZXN0b3JWZXJ0ZXgsIC8vL1xuICAgICAgICAgICAgdGFyZ2V0VmVydGV4ID0gdmVydGV4LCAgLy8vXG4gICAgICAgICAgICBlZGdlID0gbmV3IEVkZ2Uoc291cmNlVmVydGV4LCB0YXJnZXRWZXJ0ZXgpLFxuICAgICAgICAgICAgaW5jb21pbmdFZGdlID0gZWRnZSwgIC8vL1xuICAgICAgICAgICAgb3V0Z29pbmdFZGdlID0gZWRnZTsgIC8vL1xuXG4gICAgICBlZGdlcy5wdXNoKGVkZ2UpO1xuXG4gICAgICBzb3VyY2VWZXJ0ZXguYWRkT3V0Z29pbmdFZGdlKG91dGdvaW5nRWRnZSk7XG5cbiAgICAgIHRhcmdldFZlcnRleC5hZGRJbmNvbWluZ0VkZ2UoaW5jb21pbmdFZGdlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgcmV0dXJuIGVkZ2VzO1xufVxuXG5mdW5jdGlvbiB0b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRpY2VzRnJvbVZlcnRleE1hcEFuZEVkZ2VzKHZlcnRleE1hcCwgZWRnZXMpIHtcbiAgbGV0IHRvcG9sb2dpY2FsbHlPcmRlcmVkVmVydGljZXMgPSBbXTtcblxuICBjb25zdCBzdGFydGluZ1ZlcnRpY2VzID0gc3RhcnRpbmdWZXJ0aWNlc0Zyb21WZXJ0ZXhNYXAodmVydGV4TWFwKSxcbiAgICAgICAgcmVtb3ZlZEVkZ2VzID0gW107XG5cbiAgbGV0IHN0YXJ0aW5nVmVydGljZXNMZW5ndGggPSBzdGFydGluZ1ZlcnRpY2VzLmxlbmd0aDtcblxuICB3aGlsZSAoc3RhcnRpbmdWZXJ0aWNlc0xlbmd0aCA+IDApIHtcbiAgICBjb25zdCBzdGFydGluZ1ZlcnRleCA9IHN0YXJ0aW5nVmVydGljZXMucG9wKCksXG4gICAgICAgICAgdG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0ZXggPSBzdGFydGluZ1ZlcnRleDsgIC8vL1xuXG4gICAgdG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0aWNlcy5wdXNoKHRvcG9sb2dpY2FsbHlPcmRlcmVkVmVydGV4KTtcblxuICAgIGFycmF5VXRpbC5iYWNrd2FyZHNGb3JFYWNoKGVkZ2VzLCBmdW5jdGlvbihlZGdlLCBpbmRleCkge1xuICAgICAgY29uc3Qgc291cmNlVmVydGV4ID0gZWRnZS5nZXRTb3VyY2VWZXJ0ZXgoKSxcbiAgICAgICAgICAgIGVkZ2VTdGFydGluZyA9IChzb3VyY2VWZXJ0ZXggPT09IHN0YXJ0aW5nVmVydGV4KTsgLy8vXG5cbiAgICAgIGlmIChlZGdlU3RhcnRpbmcpIHtcbiAgICAgICAgZWRnZXMuc3BsaWNlKGluZGV4LCAxKTtcblxuICAgICAgICBjb25zdCB0YXJnZXRWZXJ0ZXggPSBlZGdlLmdldFRhcmdldFZlcnRleCgpLFxuICAgICAgICAgICAgICBpbmNvbWluZ0VkZ2UgPSBlZGdlLCAvLy9cbiAgICAgICAgICAgICAgcmVtb3ZlZEVkZ2UgPSBlZGdlOyAgLy8vXG5cbiAgICAgICAgdGFyZ2V0VmVydGV4LnJlbW92ZUluY29taW5nRWRnZShpbmNvbWluZ0VkZ2UpO1xuXG4gICAgICAgIHJlbW92ZWRFZGdlcy5wdXNoKHJlbW92ZWRFZGdlKTtcblxuICAgICAgICBjb25zdCB0YXJnZXRWZXJ0ZXhTdGFydGluZyA9IHRhcmdldFZlcnRleC5pc1N0YXJ0aW5nKCk7XG5cbiAgICAgICAgaWYgKHRhcmdldFZlcnRleFN0YXJ0aW5nKSB7XG4gICAgICAgICAgY29uc3Qgc3RhcnRpbmdWZXJ0ZXggPSB0YXJnZXRWZXJ0ZXg7ICAvLy9cblxuICAgICAgICAgIHN0YXJ0aW5nVmVydGljZXMucHVzaChzdGFydGluZ1ZlcnRleCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHN0YXJ0aW5nVmVydGljZXNMZW5ndGggPSBzdGFydGluZ1ZlcnRpY2VzLmxlbmd0aDtcbiAgfVxuXG4gIGNvbnN0IGVkZ2VzTGVuZ3RoID0gZWRnZXMubGVuZ3RoO1xuXG4gIGlmIChlZGdlc0xlbmd0aCA9PT0gMCkge1xuICAgIHJlbW92ZWRFZGdlcy5mb3JFYWNoKGZ1bmN0aW9uKHJlbW92ZWRFZGdlKSB7XG4gICAgICBjb25zdCB0YXJnZXRWZXJ0ZXggPSByZW1vdmVkRWRnZS5nZXRUYXJnZXRWZXJ0ZXgoKSxcbiAgICAgICAgICAgIGluY29taW5nRWRnZSA9IHJlbW92ZWRFZGdlOyAvLy9cbiAgICAgIFxuICAgICAgdGFyZ2V0VmVydGV4LmFkZEluY29taW5nRWRnZShpbmNvbWluZ0VkZ2UpO1xuICAgIH0pXG4gIH1cblxuICByZXR1cm4gdG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0aWNlcztcbn1cblxuZnVuY3Rpb24gc3RhcnRpbmdWZXJ0aWNlc0Zyb21WZXJ0ZXhNYXAodmVydGV4TWFwKSB7XG4gIGNvbnN0IHZlcnRleE5hbWVzID0gT2JqZWN0LmtleXModmVydGV4TWFwKSxcbiAgICAgICAgc3RhcnRpbmdWZXJ0aWNlcyA9IHZlcnRleE5hbWVzLnJlZHVjZShmdW5jdGlvbihzdGFydGluZ1ZlcnRpY2VzLCB2ZXJ0ZXhOYW1lKSB7XG4gICAgICAgICAgY29uc3QgdmVydGV4ID0gdmVydGV4TWFwW3ZlcnRleE5hbWVdLFxuICAgICAgICAgICAgICAgIHZlcnRleFN0YXJ0aW5nID0gdmVydGV4LmlzU3RhcnRpbmcoKTtcblxuICAgICAgICAgIGlmICh2ZXJ0ZXhTdGFydGluZykge1xuICAgICAgICAgICAgY29uc3Qgc3RhcnRpbmdWZXJ0ZXggPSB2ZXJ0ZXg7ICAvLy9cblxuICAgICAgICAgICAgc3RhcnRpbmdWZXJ0aWNlcy5wdXNoKHN0YXJ0aW5nVmVydGV4KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gc3RhcnRpbmdWZXJ0aWNlc1xuICAgICAgICB9LCBbXSk7XG5cbiAgcmV0dXJuIHN0YXJ0aW5nVmVydGljZXM7XG59XG4iXX0=