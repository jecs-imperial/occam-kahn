'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Edge = require('./graph/edge'),
    Vertex = require('./graph/vertex'),
    arrayUtil = require('./util/array');

var Graph = function () {
  function Graph(topologicallySortedVertices) {
    _classCallCheck(this, Graph);

    this.topologicallySortedVertices = topologicallySortedVertices;
  }

  _createClass(Graph, [{
    key: 'getTopologicallySortedVertices',
    value: function getTopologicallySortedVertices() {
      return this.topologicallySortedVertices;
    }
  }], [{
    key: 'fromVertexLiterals',
    value: function fromVertexLiterals(vertexLiterals) {
      var vertexMap = vertexMapFromVertexLiterals(vertexLiterals),
          edges = edgesFromVertexLiteralsAndVertexMap(vertexLiterals, vertexMap),
          topologicallySortedVertices = topologicallySortedVerticesFromVertexMapAndEdges(vertexMap, edges),
          graph = new Graph(topologicallySortedVertices);

      return graph;
    }
  }]);

  return Graph;
}();

module.exports = Graph;

function vertexMapFromVertexLiterals(vertexLiterals) {
  var vertexMap = {};

  vertexLiterals.forEach(function (vertexLiteral) {
    var firstVertexLiteralElement = arrayUtil.first(vertexLiteral),
        vertexName = firstVertexLiteralElement,
        ///
    vertexExists = vertexMap.hasOwnProperty(vertexName);

    if (!vertexExists) {
      var vertex = Vertex.fromVertexName(vertexName);

      vertexMap[vertexName] = vertex;
    }

    var secondVertexLiteralElement = arrayUtil.second(vertexLiteral),
        ancestorVertexNames = secondVertexLiteralElement; ///

    ancestorVertexNames.forEach(function (ancestorVertexName) {
      var ancestorVertexExists = vertexMap.hasOwnProperty(ancestorVertexName);

      if (!ancestorVertexExists) {
        var ancestorVertex = Vertex.fromVertexName(ancestorVertexName);

        vertexMap[ancestorVertexName] = ancestorVertex;
      }
    });
  });

  return vertexMap;
}

function edgesFromVertexLiteralsAndVertexMap(vertexLiterals, vertexMap) {
  var edges = [];

  vertexLiterals.forEach(function (vertexLiteral) {
    var firstVertexLiteralElement = arrayUtil.first(vertexLiteral),
        secondVertexLiteralElement = arrayUtil.second(vertexLiteral),
        ancestorVertexNames = secondVertexLiteralElement,
        ///
    vertexName = firstVertexLiteralElement,
        ///
    vertex = vertexMap[vertexName];

    ancestorVertexNames.forEach(function (ancestorVertexName) {
      var ancestorVertex = vertexMap[ancestorVertexName],
          sourceVertex = ancestorVertex,
          ///
      targetVertex = vertex,
          ///
      edge = new Edge(sourceVertex, targetVertex),
          incomingEdge = edge,
          ///
      outgoingEdge = edge; ///

      edges.push(edge);

      vertex.addIncomingEdge(incomingEdge);

      ancestorVertex.addOutgoingEdge(outgoingEdge);
    });
  });

  return edges;
}

function topologicallySortedVerticesFromVertexMapAndEdges(vertexMap, edges) {
  var topologicallySortedVertices = [];

  var vertexNames = Object.keys(vertexMap),
      startingVertices = vertexNames.reduce(function (startingVertices, vertexName) {
    var vertex = vertexMap[vertexName],
        vertexStarting = vertex.isStarting();

    if (vertexStarting) {
      var startingVertex = vertex; ///

      startingVertices.push(startingVertex);
    }

    return startingVertices;
  }, []);

  var startingVerticesLength = startingVertices.length;

  var _loop = function _loop() {
    var startingVertex = startingVertices.pop(),
        topologicallySortedVertex = startingVertex; ///

    topologicallySortedVertices.push(topologicallySortedVertex);

    arrayUtil.backwardsForEach(edges, function (edge, index) {
      var sourceVertex = edge.getSourceVertex(),
          edgeStarting = sourceVertex === startingVertex;

      if (edgeStarting) {
        edges.splice(index, 1);

        var lastVertex = edge.getTargetVertex(),
            incomingEdge = edge; ///

        lastVertex.removeIncomingEdge(incomingEdge);

        var lastVertexStarting = lastVertex.isStarting();

        if (lastVertexStarting) {
          startingVertices.push(lastVertex);
        }
      }
    });

    startingVerticesLength = startingVertices.length;
  };

  while (startingVerticesLength > 0) {
    _loop();
  }

  var edgesLength = edges.length;

  if (edgesLength > 0) {
    topologicallySortedVertices = null;
  }

  return topologicallySortedVertices;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9ncmFwaC5qcyJdLCJuYW1lcyI6WyJFZGdlIiwicmVxdWlyZSIsIlZlcnRleCIsImFycmF5VXRpbCIsIkdyYXBoIiwidG9wb2xvZ2ljYWxseVNvcnRlZFZlcnRpY2VzIiwidmVydGV4TGl0ZXJhbHMiLCJ2ZXJ0ZXhNYXAiLCJ2ZXJ0ZXhNYXBGcm9tVmVydGV4TGl0ZXJhbHMiLCJlZGdlcyIsImVkZ2VzRnJvbVZlcnRleExpdGVyYWxzQW5kVmVydGV4TWFwIiwidG9wb2xvZ2ljYWxseVNvcnRlZFZlcnRpY2VzRnJvbVZlcnRleE1hcEFuZEVkZ2VzIiwiZ3JhcGgiLCJtb2R1bGUiLCJleHBvcnRzIiwiZm9yRWFjaCIsInZlcnRleExpdGVyYWwiLCJmaXJzdFZlcnRleExpdGVyYWxFbGVtZW50IiwiZmlyc3QiLCJ2ZXJ0ZXhOYW1lIiwidmVydGV4RXhpc3RzIiwiaGFzT3duUHJvcGVydHkiLCJ2ZXJ0ZXgiLCJmcm9tVmVydGV4TmFtZSIsInNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50Iiwic2Vjb25kIiwiYW5jZXN0b3JWZXJ0ZXhOYW1lcyIsImFuY2VzdG9yVmVydGV4TmFtZSIsImFuY2VzdG9yVmVydGV4RXhpc3RzIiwiYW5jZXN0b3JWZXJ0ZXgiLCJzb3VyY2VWZXJ0ZXgiLCJ0YXJnZXRWZXJ0ZXgiLCJlZGdlIiwiaW5jb21pbmdFZGdlIiwib3V0Z29pbmdFZGdlIiwicHVzaCIsImFkZEluY29taW5nRWRnZSIsImFkZE91dGdvaW5nRWRnZSIsInZlcnRleE5hbWVzIiwiT2JqZWN0Iiwia2V5cyIsInN0YXJ0aW5nVmVydGljZXMiLCJyZWR1Y2UiLCJ2ZXJ0ZXhTdGFydGluZyIsImlzU3RhcnRpbmciLCJzdGFydGluZ1ZlcnRleCIsInN0YXJ0aW5nVmVydGljZXNMZW5ndGgiLCJsZW5ndGgiLCJwb3AiLCJ0b3BvbG9naWNhbGx5U29ydGVkVmVydGV4IiwiYmFja3dhcmRzRm9yRWFjaCIsImluZGV4IiwiZ2V0U291cmNlVmVydGV4IiwiZWRnZVN0YXJ0aW5nIiwic3BsaWNlIiwibGFzdFZlcnRleCIsImdldFRhcmdldFZlcnRleCIsInJlbW92ZUluY29taW5nRWRnZSIsImxhc3RWZXJ0ZXhTdGFydGluZyIsImVkZ2VzTGVuZ3RoIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsT0FBT0MsUUFBUSxjQUFSLENBQWI7QUFBQSxJQUNNQyxTQUFTRCxRQUFRLGdCQUFSLENBRGY7QUFBQSxJQUVNRSxZQUFZRixRQUFRLGNBQVIsQ0FGbEI7O0lBSU1HLEs7QUFDSixpQkFBYUMsMkJBQWIsRUFBMEM7QUFBQTs7QUFDeEMsU0FBS0EsMkJBQUwsR0FBbUNBLDJCQUFuQztBQUNEOzs7O3FEQUVnQztBQUMvQixhQUFPLEtBQUtBLDJCQUFaO0FBQ0Q7Ozt1Q0FFeUJDLGMsRUFBZ0I7QUFDeEMsVUFBTUMsWUFBWUMsNEJBQTRCRixjQUE1QixDQUFsQjtBQUFBLFVBQ01HLFFBQVFDLG9DQUFvQ0osY0FBcEMsRUFBb0RDLFNBQXBELENBRGQ7QUFBQSxVQUVNRiw4QkFBOEJNLGlEQUFpREosU0FBakQsRUFBNERFLEtBQTVELENBRnBDO0FBQUEsVUFHTUcsUUFBUSxJQUFJUixLQUFKLENBQVVDLDJCQUFWLENBSGQ7O0FBS0EsYUFBT08sS0FBUDtBQUNEOzs7Ozs7QUFHSEMsT0FBT0MsT0FBUCxHQUFpQlYsS0FBakI7O0FBRUEsU0FBU0ksMkJBQVQsQ0FBcUNGLGNBQXJDLEVBQXFEO0FBQ25ELE1BQU1DLFlBQVksRUFBbEI7O0FBRUFELGlCQUFlUyxPQUFmLENBQXVCLFVBQVNDLGFBQVQsRUFBd0I7QUFDN0MsUUFBTUMsNEJBQTRCZCxVQUFVZSxLQUFWLENBQWdCRixhQUFoQixDQUFsQztBQUFBLFFBQ01HLGFBQWFGLHlCQURuQjtBQUFBLFFBQzhDO0FBQ3hDRyxtQkFBZWIsVUFBVWMsY0FBVixDQUF5QkYsVUFBekIsQ0FGckI7O0FBSUEsUUFBSSxDQUFDQyxZQUFMLEVBQW1CO0FBQ2pCLFVBQU1FLFNBQVNwQixPQUFPcUIsY0FBUCxDQUFzQkosVUFBdEIsQ0FBZjs7QUFFQVosZ0JBQVVZLFVBQVYsSUFBd0JHLE1BQXhCO0FBQ0Q7O0FBRUQsUUFBTUUsNkJBQTZCckIsVUFBVXNCLE1BQVYsQ0FBaUJULGFBQWpCLENBQW5DO0FBQUEsUUFDTVUsc0JBQXNCRiwwQkFENUIsQ0FYNkMsQ0FZVzs7QUFFeERFLHdCQUFvQlgsT0FBcEIsQ0FBNEIsVUFBU1ksa0JBQVQsRUFBNkI7QUFDdkQsVUFBTUMsdUJBQXVCckIsVUFBVWMsY0FBVixDQUF5Qk0sa0JBQXpCLENBQTdCOztBQUVBLFVBQUksQ0FBQ0Msb0JBQUwsRUFBMkI7QUFDekIsWUFBTUMsaUJBQWlCM0IsT0FBT3FCLGNBQVAsQ0FBc0JJLGtCQUF0QixDQUF2Qjs7QUFFQXBCLGtCQUFVb0Isa0JBQVYsSUFBZ0NFLGNBQWhDO0FBQ0Q7QUFDRixLQVJEO0FBU0QsR0F2QkQ7O0FBeUJBLFNBQU90QixTQUFQO0FBQ0Q7O0FBRUQsU0FBU0csbUNBQVQsQ0FBNkNKLGNBQTdDLEVBQTZEQyxTQUE3RCxFQUF3RTtBQUN0RSxNQUFNRSxRQUFRLEVBQWQ7O0FBRUFILGlCQUFlUyxPQUFmLENBQXVCLFVBQVNDLGFBQVQsRUFBd0I7QUFDN0MsUUFBTUMsNEJBQTRCZCxVQUFVZSxLQUFWLENBQWdCRixhQUFoQixDQUFsQztBQUFBLFFBQ01RLDZCQUE2QnJCLFVBQVVzQixNQUFWLENBQWlCVCxhQUFqQixDQURuQztBQUFBLFFBRU1VLHNCQUFzQkYsMEJBRjVCO0FBQUEsUUFFd0Q7QUFDbERMLGlCQUFhRix5QkFIbkI7QUFBQSxRQUc4QztBQUN4Q0ssYUFBU2YsVUFBVVksVUFBVixDQUpmOztBQU1BTyx3QkFBb0JYLE9BQXBCLENBQTRCLFVBQVNZLGtCQUFULEVBQTZCO0FBQ3ZELFVBQU1FLGlCQUFpQnRCLFVBQVVvQixrQkFBVixDQUF2QjtBQUFBLFVBQ01HLGVBQWVELGNBRHJCO0FBQUEsVUFDcUM7QUFDL0JFLHFCQUFlVCxNQUZyQjtBQUFBLFVBRThCO0FBQ3hCVSxhQUFPLElBQUloQyxJQUFKLENBQVM4QixZQUFULEVBQXVCQyxZQUF2QixDQUhiO0FBQUEsVUFJTUUsZUFBZUQsSUFKckI7QUFBQSxVQUk0QjtBQUN0QkUscUJBQWVGLElBTHJCLENBRHVELENBTTNCOztBQUU1QnZCLFlBQU0wQixJQUFOLENBQVdILElBQVg7O0FBRUFWLGFBQU9jLGVBQVAsQ0FBdUJILFlBQXZCOztBQUVBSixxQkFBZVEsZUFBZixDQUErQkgsWUFBL0I7QUFDRCxLQWJEO0FBY0QsR0FyQkQ7O0FBdUJBLFNBQU96QixLQUFQO0FBQ0Q7O0FBRUQsU0FBU0UsZ0RBQVQsQ0FBMERKLFNBQTFELEVBQXFFRSxLQUFyRSxFQUE0RTtBQUMxRSxNQUFJSiw4QkFBOEIsRUFBbEM7O0FBRUEsTUFBTWlDLGNBQWNDLE9BQU9DLElBQVAsQ0FBWWpDLFNBQVosQ0FBcEI7QUFBQSxNQUNNa0MsbUJBQW1CSCxZQUFZSSxNQUFaLENBQW1CLFVBQVNELGdCQUFULEVBQTJCdEIsVUFBM0IsRUFBdUM7QUFDM0UsUUFBTUcsU0FBU2YsVUFBVVksVUFBVixDQUFmO0FBQUEsUUFDTXdCLGlCQUFpQnJCLE9BQU9zQixVQUFQLEVBRHZCOztBQUdBLFFBQUlELGNBQUosRUFBb0I7QUFDbEIsVUFBTUUsaUJBQWlCdkIsTUFBdkIsQ0FEa0IsQ0FDYzs7QUFFaENtQix1QkFBaUJOLElBQWpCLENBQXNCVSxjQUF0QjtBQUNEOztBQUVELFdBQU9KLGdCQUFQO0FBQ0QsR0FYa0IsRUFXaEIsRUFYZ0IsQ0FEekI7O0FBY0EsTUFBSUsseUJBQXlCTCxpQkFBaUJNLE1BQTlDOztBQWpCMEU7QUFvQnhFLFFBQU1GLGlCQUFpQkosaUJBQWlCTyxHQUFqQixFQUF2QjtBQUFBLFFBQ01DLDRCQUE0QkosY0FEbEMsQ0FwQndFLENBcUJyQjs7QUFFbkR4QyxnQ0FBNEI4QixJQUE1QixDQUFpQ2MseUJBQWpDOztBQUVBOUMsY0FBVStDLGdCQUFWLENBQTJCekMsS0FBM0IsRUFBa0MsVUFBU3VCLElBQVQsRUFBZW1CLEtBQWYsRUFBc0I7QUFDdEQsVUFBTXJCLGVBQWVFLEtBQUtvQixlQUFMLEVBQXJCO0FBQUEsVUFDTUMsZUFBZ0J2QixpQkFBaUJlLGNBRHZDOztBQUdBLFVBQUlRLFlBQUosRUFBa0I7QUFDaEI1QyxjQUFNNkMsTUFBTixDQUFhSCxLQUFiLEVBQW9CLENBQXBCOztBQUVBLFlBQU1JLGFBQWF2QixLQUFLd0IsZUFBTCxFQUFuQjtBQUFBLFlBQ012QixlQUFlRCxJQURyQixDQUhnQixDQUlZOztBQUU1QnVCLG1CQUFXRSxrQkFBWCxDQUE4QnhCLFlBQTlCOztBQUVBLFlBQU15QixxQkFBcUJILFdBQVdYLFVBQVgsRUFBM0I7O0FBRUEsWUFBSWMsa0JBQUosRUFBd0I7QUFDdEJqQiwyQkFBaUJOLElBQWpCLENBQXNCb0IsVUFBdEI7QUFDRDtBQUNGO0FBQ0YsS0FsQkQ7O0FBb0JBVCw2QkFBeUJMLGlCQUFpQk0sTUFBMUM7QUE3Q3dFOztBQW1CMUUsU0FBT0QseUJBQXlCLENBQWhDLEVBQW1DO0FBQUE7QUEyQmxDOztBQUVELE1BQU1hLGNBQWNsRCxNQUFNc0MsTUFBMUI7O0FBRUEsTUFBSVksY0FBYyxDQUFsQixFQUFxQjtBQUNuQnRELGtDQUE4QixJQUE5QjtBQUNEOztBQUVELFNBQU9BLDJCQUFQO0FBQ0QiLCJmaWxlIjoiZ3JhcGguanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IEVkZ2UgPSByZXF1aXJlKCcuL2dyYXBoL2VkZ2UnKSxcbiAgICAgIFZlcnRleCA9IHJlcXVpcmUoJy4vZ3JhcGgvdmVydGV4JyksXG4gICAgICBhcnJheVV0aWwgPSByZXF1aXJlKCcuL3V0aWwvYXJyYXknKTtcblxuY2xhc3MgR3JhcGgge1xuICBjb25zdHJ1Y3RvciAodG9wb2xvZ2ljYWxseVNvcnRlZFZlcnRpY2VzKSB7XG4gICAgdGhpcy50b3BvbG9naWNhbGx5U29ydGVkVmVydGljZXMgPSB0b3BvbG9naWNhbGx5U29ydGVkVmVydGljZXM7XG4gIH1cblxuICBnZXRUb3BvbG9naWNhbGx5U29ydGVkVmVydGljZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMudG9wb2xvZ2ljYWxseVNvcnRlZFZlcnRpY2VzO1xuICB9XG5cbiAgc3RhdGljIGZyb21WZXJ0ZXhMaXRlcmFscyh2ZXJ0ZXhMaXRlcmFscykge1xuICAgIGNvbnN0IHZlcnRleE1hcCA9IHZlcnRleE1hcEZyb21WZXJ0ZXhMaXRlcmFscyh2ZXJ0ZXhMaXRlcmFscyksXG4gICAgICAgICAgZWRnZXMgPSBlZGdlc0Zyb21WZXJ0ZXhMaXRlcmFsc0FuZFZlcnRleE1hcCh2ZXJ0ZXhMaXRlcmFscywgdmVydGV4TWFwKSxcbiAgICAgICAgICB0b3BvbG9naWNhbGx5U29ydGVkVmVydGljZXMgPSB0b3BvbG9naWNhbGx5U29ydGVkVmVydGljZXNGcm9tVmVydGV4TWFwQW5kRWRnZXModmVydGV4TWFwLCBlZGdlcyksXG4gICAgICAgICAgZ3JhcGggPSBuZXcgR3JhcGgodG9wb2xvZ2ljYWxseVNvcnRlZFZlcnRpY2VzKTtcbiAgICBcbiAgICByZXR1cm4gZ3JhcGg7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBHcmFwaDtcblxuZnVuY3Rpb24gdmVydGV4TWFwRnJvbVZlcnRleExpdGVyYWxzKHZlcnRleExpdGVyYWxzKSB7XG4gIGNvbnN0IHZlcnRleE1hcCA9IHt9O1xuXG4gIHZlcnRleExpdGVyYWxzLmZvckVhY2goZnVuY3Rpb24odmVydGV4TGl0ZXJhbCkge1xuICAgIGNvbnN0IGZpcnN0VmVydGV4TGl0ZXJhbEVsZW1lbnQgPSBhcnJheVV0aWwuZmlyc3QodmVydGV4TGl0ZXJhbCksXG4gICAgICAgICAgdmVydGV4TmFtZSA9IGZpcnN0VmVydGV4TGl0ZXJhbEVsZW1lbnQsIC8vL1xuICAgICAgICAgIHZlcnRleEV4aXN0cyA9IHZlcnRleE1hcC5oYXNPd25Qcm9wZXJ0eSh2ZXJ0ZXhOYW1lKTtcblxuICAgIGlmICghdmVydGV4RXhpc3RzKSB7XG4gICAgICBjb25zdCB2ZXJ0ZXggPSBWZXJ0ZXguZnJvbVZlcnRleE5hbWUodmVydGV4TmFtZSk7XG5cbiAgICAgIHZlcnRleE1hcFt2ZXJ0ZXhOYW1lXSA9IHZlcnRleDtcbiAgICB9XG5cbiAgICBjb25zdCBzZWNvbmRWZXJ0ZXhMaXRlcmFsRWxlbWVudCA9IGFycmF5VXRpbC5zZWNvbmQodmVydGV4TGl0ZXJhbCksXG4gICAgICAgICAgYW5jZXN0b3JWZXJ0ZXhOYW1lcyA9IHNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50OyAvLy9cblxuICAgIGFuY2VzdG9yVmVydGV4TmFtZXMuZm9yRWFjaChmdW5jdGlvbihhbmNlc3RvclZlcnRleE5hbWUpIHtcbiAgICAgIGNvbnN0IGFuY2VzdG9yVmVydGV4RXhpc3RzID0gdmVydGV4TWFwLmhhc093blByb3BlcnR5KGFuY2VzdG9yVmVydGV4TmFtZSk7XG5cbiAgICAgIGlmICghYW5jZXN0b3JWZXJ0ZXhFeGlzdHMpIHtcbiAgICAgICAgY29uc3QgYW5jZXN0b3JWZXJ0ZXggPSBWZXJ0ZXguZnJvbVZlcnRleE5hbWUoYW5jZXN0b3JWZXJ0ZXhOYW1lKTtcblxuICAgICAgICB2ZXJ0ZXhNYXBbYW5jZXN0b3JWZXJ0ZXhOYW1lXSA9IGFuY2VzdG9yVmVydGV4O1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gdmVydGV4TWFwO1xufVxuXG5mdW5jdGlvbiBlZGdlc0Zyb21WZXJ0ZXhMaXRlcmFsc0FuZFZlcnRleE1hcCh2ZXJ0ZXhMaXRlcmFscywgdmVydGV4TWFwKSB7XG4gIGNvbnN0IGVkZ2VzID0gW107XG5cbiAgdmVydGV4TGl0ZXJhbHMuZm9yRWFjaChmdW5jdGlvbih2ZXJ0ZXhMaXRlcmFsKSB7XG4gICAgY29uc3QgZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCA9IGFycmF5VXRpbC5maXJzdCh2ZXJ0ZXhMaXRlcmFsKSxcbiAgICAgICAgICBzZWNvbmRWZXJ0ZXhMaXRlcmFsRWxlbWVudCA9IGFycmF5VXRpbC5zZWNvbmQodmVydGV4TGl0ZXJhbCksXG4gICAgICAgICAgYW5jZXN0b3JWZXJ0ZXhOYW1lcyA9IHNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50LCAvLy9cbiAgICAgICAgICB2ZXJ0ZXhOYW1lID0gZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCwgLy8vXG4gICAgICAgICAgdmVydGV4ID0gdmVydGV4TWFwW3ZlcnRleE5hbWVdO1xuXG4gICAgYW5jZXN0b3JWZXJ0ZXhOYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKGFuY2VzdG9yVmVydGV4TmFtZSkge1xuICAgICAgY29uc3QgYW5jZXN0b3JWZXJ0ZXggPSB2ZXJ0ZXhNYXBbYW5jZXN0b3JWZXJ0ZXhOYW1lXSxcbiAgICAgICAgICAgIHNvdXJjZVZlcnRleCA9IGFuY2VzdG9yVmVydGV4LCAvLy9cbiAgICAgICAgICAgIHRhcmdldFZlcnRleCA9IHZlcnRleCwgIC8vL1xuICAgICAgICAgICAgZWRnZSA9IG5ldyBFZGdlKHNvdXJjZVZlcnRleCwgdGFyZ2V0VmVydGV4KSxcbiAgICAgICAgICAgIGluY29taW5nRWRnZSA9IGVkZ2UsICAvLy9cbiAgICAgICAgICAgIG91dGdvaW5nRWRnZSA9IGVkZ2U7ICAvLy9cblxuICAgICAgZWRnZXMucHVzaChlZGdlKTtcblxuICAgICAgdmVydGV4LmFkZEluY29taW5nRWRnZShpbmNvbWluZ0VkZ2UpO1xuXG4gICAgICBhbmNlc3RvclZlcnRleC5hZGRPdXRnb2luZ0VkZ2Uob3V0Z29pbmdFZGdlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgcmV0dXJuIGVkZ2VzO1xufVxuXG5mdW5jdGlvbiB0b3BvbG9naWNhbGx5U29ydGVkVmVydGljZXNGcm9tVmVydGV4TWFwQW5kRWRnZXModmVydGV4TWFwLCBlZGdlcykge1xuICBsZXQgdG9wb2xvZ2ljYWxseVNvcnRlZFZlcnRpY2VzID0gW107XG5cbiAgY29uc3QgdmVydGV4TmFtZXMgPSBPYmplY3Qua2V5cyh2ZXJ0ZXhNYXApLFxuICAgICAgICBzdGFydGluZ1ZlcnRpY2VzID0gdmVydGV4TmFtZXMucmVkdWNlKGZ1bmN0aW9uKHN0YXJ0aW5nVmVydGljZXMsIHZlcnRleE5hbWUpIHtcbiAgICAgICAgICBjb25zdCB2ZXJ0ZXggPSB2ZXJ0ZXhNYXBbdmVydGV4TmFtZV0sXG4gICAgICAgICAgICAgICAgdmVydGV4U3RhcnRpbmcgPSB2ZXJ0ZXguaXNTdGFydGluZygpO1xuXG4gICAgICAgICAgaWYgKHZlcnRleFN0YXJ0aW5nKSB7XG4gICAgICAgICAgICBjb25zdCBzdGFydGluZ1ZlcnRleCA9IHZlcnRleDsgIC8vL1xuXG4gICAgICAgICAgICBzdGFydGluZ1ZlcnRpY2VzLnB1c2goc3RhcnRpbmdWZXJ0ZXgpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBzdGFydGluZ1ZlcnRpY2VzXG4gICAgICAgIH0sIFtdKTtcblxuICBsZXQgc3RhcnRpbmdWZXJ0aWNlc0xlbmd0aCA9IHN0YXJ0aW5nVmVydGljZXMubGVuZ3RoO1xuXG4gIHdoaWxlIChzdGFydGluZ1ZlcnRpY2VzTGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IHN0YXJ0aW5nVmVydGV4ID0gc3RhcnRpbmdWZXJ0aWNlcy5wb3AoKSxcbiAgICAgICAgICB0b3BvbG9naWNhbGx5U29ydGVkVmVydGV4ID0gc3RhcnRpbmdWZXJ0ZXg7ICAvLy9cblxuICAgIHRvcG9sb2dpY2FsbHlTb3J0ZWRWZXJ0aWNlcy5wdXNoKHRvcG9sb2dpY2FsbHlTb3J0ZWRWZXJ0ZXgpO1xuXG4gICAgYXJyYXlVdGlsLmJhY2t3YXJkc0ZvckVhY2goZWRnZXMsIGZ1bmN0aW9uKGVkZ2UsIGluZGV4KSB7XG4gICAgICBjb25zdCBzb3VyY2VWZXJ0ZXggPSBlZGdlLmdldFNvdXJjZVZlcnRleCgpLFxuICAgICAgICAgICAgZWRnZVN0YXJ0aW5nID0gKHNvdXJjZVZlcnRleCA9PT0gc3RhcnRpbmdWZXJ0ZXgpO1xuXG4gICAgICBpZiAoZWRnZVN0YXJ0aW5nKSB7XG4gICAgICAgIGVkZ2VzLnNwbGljZShpbmRleCwgMSk7XG5cbiAgICAgICAgY29uc3QgbGFzdFZlcnRleCA9IGVkZ2UuZ2V0VGFyZ2V0VmVydGV4KCksXG4gICAgICAgICAgICAgIGluY29taW5nRWRnZSA9IGVkZ2U7ICAvLy9cblxuICAgICAgICBsYXN0VmVydGV4LnJlbW92ZUluY29taW5nRWRnZShpbmNvbWluZ0VkZ2UpO1xuXG4gICAgICAgIGNvbnN0IGxhc3RWZXJ0ZXhTdGFydGluZyA9IGxhc3RWZXJ0ZXguaXNTdGFydGluZygpO1xuXG4gICAgICAgIGlmIChsYXN0VmVydGV4U3RhcnRpbmcpIHtcbiAgICAgICAgICBzdGFydGluZ1ZlcnRpY2VzLnB1c2gobGFzdFZlcnRleCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHN0YXJ0aW5nVmVydGljZXNMZW5ndGggPSBzdGFydGluZ1ZlcnRpY2VzLmxlbmd0aDtcbiAgfVxuXG4gIGNvbnN0IGVkZ2VzTGVuZ3RoID0gZWRnZXMubGVuZ3RoO1xuXG4gIGlmIChlZGdlc0xlbmd0aCA+IDApIHtcbiAgICB0b3BvbG9naWNhbGx5U29ydGVkVmVydGljZXMgPSBudWxsO1xuICB9XG5cbiAgcmV0dXJuIHRvcG9sb2dpY2FsbHlTb3J0ZWRWZXJ0aWNlcztcbn1cbiJdfQ==