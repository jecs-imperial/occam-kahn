"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _necessary = require("necessary");

var _edge = _interopRequireDefault(require("./edge"));

var _vertex = _interopRequireDefault(require("./vertex"));

var _remainingEdges = _interopRequireDefault(require("./remainingEdges"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var first = _necessary.arrayUtilities.first,
    second = _necessary.arrayUtilities.second,
    backwardsForEach = _necessary.arrayUtilities.backwardsForEach;

var Graph = /*#__PURE__*/function () {
  function Graph(orderedVertices, remainingEdges) {
    _classCallCheck(this, Graph);

    this.orderedVertices = orderedVertices;
    this.remainingEdges = remainingEdges;
  }

  _createClass(Graph, [{
    key: "getOrderedVertices",
    value: function getOrderedVertices() {
      return this.orderedVertices;
    }
  }, {
    key: "getRemainingEdges",
    value: function getRemainingEdges() {
      return this.remainingEdges;
    }
  }, {
    key: "areCyclesPresent",
    value: function areCyclesPresent() {
      return this.remainingEdges.areCyclesPresent();
    }
  }], [{
    key: "fromVertexLiterals",
    value: function fromVertexLiterals(vertexLiterals) {
      var vertexMap = vertexMapFromVertexLiterals(vertexLiterals),
          edges = edgesFromVertexLiteralsAndVertexMap(vertexLiterals, vertexMap),
          orderedVertices = orderedVerticesFromVertexMapAndEdges(vertexMap, edges),
          remainingEdges = new _remainingEdges["default"](edges),
          graph = new Graph(orderedVertices, remainingEdges);
      return graph;
    }
  }, {
    key: "fromVertexNamesAndEdges",
    value: function fromVertexNamesAndEdges(vertexNames, edges) {
      edges = edges.slice(); ///

      var vertexMap = vertexMapFromVertexNamesAndEdges(vertexNames, edges),
          orderedVertices = orderedVerticesFromVertexMapAndEdges(vertexMap, edges),
          remainingEdges = new _remainingEdges["default"](edges),
          graph = new Graph(orderedVertices, remainingEdges);
      return graph;
    }
  }]);

  return Graph;
}();

exports["default"] = Graph;

function vertexMapFromVertexNamesAndEdges(vertexNames, edges) {
  var vertexMap = {};
  vertexNames.forEach(function (vertexName) {
    var vertexExists = vertexMap.hasOwnProperty(vertexName);

    if (!vertexExists) {
      var vertex = _vertex["default"].fromVertexName(vertexName);

      vertexMap[vertexName] = vertex;
    }
  });
  edges.forEach(function (edge) {
    var sourceVertexName = edge.getSourceVertexName(),
        targetVertexName = edge.getTargetVertexName(),
        sourceVertexExists = vertexMap.hasOwnProperty(sourceVertexName),
        targetVertexExists = vertexMap.hasOwnProperty(targetVertexName);

    if (!sourceVertexExists) {
      var _sourceVertex = _vertex["default"].fromVertexName(sourceVertexName);

      vertexMap[sourceVertexName] = _sourceVertex;
    }

    if (!targetVertexExists) {
      var _targetVertex = _vertex["default"].fromVertexName(targetVertexName);

      vertexMap[targetVertexName] = _targetVertex;
    }

    var sourceVertex = vertexMap[sourceVertexName],
        targetVertex = vertexMap[targetVertexName],
        incomingEdge = edge,
        ///
    outgoingEdge = edge; ///

    sourceVertex.addOutgoingEdge(outgoingEdge);
    targetVertex.addIncomingEdge(incomingEdge);
  });
  return vertexMap;
}

function vertexMapFromVertexLiterals(vertexLiterals) {
  var vertexMap = {};
  vertexLiterals.forEach(function (vertexLiteral) {
    var firstVertexLiteralElement = first(vertexLiteral),
        vertexName = firstVertexLiteralElement,
        ///
    vertexExists = vertexMap.hasOwnProperty(vertexName);

    if (!vertexExists) {
      var vertex = _vertex["default"].fromVertexName(vertexName);

      vertexMap[vertexName] = vertex;
    }

    var secondVertexLiteralElement = second(vertexLiteral),
        ancestorVertexNames = secondVertexLiteralElement; ///

    ancestorVertexNames.forEach(function (ancestorVertexName) {
      var ancestorVertexExists = vertexMap.hasOwnProperty(ancestorVertexName);

      if (!ancestorVertexExists) {
        var ancestorVertex = _vertex["default"].fromVertexName(ancestorVertexName);

        vertexMap[ancestorVertexName] = ancestorVertex;
      }
    });
  });
  return vertexMap;
}

function edgesFromVertexLiteralsAndVertexMap(vertexLiterals, vertexMap) {
  var edges = [];
  vertexLiterals.forEach(function (vertexLiteral) {
    var firstVertexLiteralElement = first(vertexLiteral),
        secondVertexLiteralElement = second(vertexLiteral),
        ancestorVertexNames = secondVertexLiteralElement,
        ///
    vertexName = firstVertexLiteralElement; ///

    ancestorVertexNames.forEach(function (ancestorVertexName) {
      var sourceVertexName = ancestorVertexName,
          ///
      targetVertexName = vertexName,
          ///
      sourceVertex = vertexMap[sourceVertexName],
          targetVertex = vertexMap[targetVertexName],
          edge = new _edge["default"](sourceVertexName, targetVertexName),
          incomingEdge = edge,
          ///
      outgoingEdge = edge; ///

      edges.push(edge);
      sourceVertex.addOutgoingEdge(outgoingEdge);
      targetVertex.addIncomingEdge(incomingEdge);
    });
  });
  return edges;
}

function orderedVerticesFromVertexMapAndEdges(vertexMap, edges) {
  var orderedVertexNames = [],
      startingVertexNames = startingVertexNamesFromVertexMap(vertexMap),
      removedEdges = [];
  var startingVertexNamesLength = startingVertexNames.length;

  var _loop = function _loop() {
    var startingVertexName = startingVertexNames.pop(),
        orderedVertexName = startingVertexName; ///

    orderedVertexNames.push(orderedVertexName);
    backwardsForEach(edges, function (edge, index) {
      var sourceVertexName = edge.getSourceVertexName(),
          edgeStarting = sourceVertexName === startingVertexName; ///

      if (edgeStarting) {
        edges.splice(index, 1);
        var targetVertexName = edge.getTargetVertexName(),
            targetVertex = vertexMap[targetVertexName],
            incomingEdge = edge,
            ///
        removedEdge = edge; ///

        targetVertex.removeIncomingEdge(incomingEdge);
        removedEdges.push(removedEdge);
        var targetVertexStarting = targetVertex.isStarting();

        if (targetVertexStarting) {
          var _startingVertexName = targetVertexName; ///

          startingVertexNames.push(_startingVertexName);
        }
      }
    });
    startingVertexNamesLength = startingVertexNames.length;
  };

  while (startingVertexNamesLength > 0) {
    _loop();
  }

  var edgesLength = edges.length;

  if (edgesLength === 0) {
    removedEdges.forEach(function (removedEdge) {
      var targetVertexName = removedEdge.getTargetVertexName(),
          targetVertex = vertexMap[targetVertexName],
          incomingEdge = removedEdge; ///

      targetVertex.addIncomingEdge(incomingEdge);
    });
  }

  var topologicallySortedVertices = orderedVertexNames.map(function (orderedVertexName) {
    var orderedVertex = vertexMap[orderedVertexName];
    return orderedVertex;
  });
  return topologicallySortedVertices;
}

function startingVertexNamesFromVertexMap(vertexMap) {
  var vertexNames = Object.keys(vertexMap),
      startingVertexNames = vertexNames.reduce(function (startingVertexNames, vertexName) {
    var vertex = vertexMap[vertexName],
        vertexStarting = vertex.isStarting();

    if (vertexStarting) {
      var startingVertexName = vertexName; ///

      startingVertexNames.push(startingVertexName);
    }

    return startingVertexNames;
  }, []);
  return startingVertexNames;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdyYXBoLmpzIl0sIm5hbWVzIjpbImZpcnN0IiwiYXJyYXlVdGlsaXRpZXMiLCJzZWNvbmQiLCJiYWNrd2FyZHNGb3JFYWNoIiwiR3JhcGgiLCJvcmRlcmVkVmVydGljZXMiLCJyZW1haW5pbmdFZGdlcyIsImFyZUN5Y2xlc1ByZXNlbnQiLCJ2ZXJ0ZXhMaXRlcmFscyIsInZlcnRleE1hcCIsInZlcnRleE1hcEZyb21WZXJ0ZXhMaXRlcmFscyIsImVkZ2VzIiwiZWRnZXNGcm9tVmVydGV4TGl0ZXJhbHNBbmRWZXJ0ZXhNYXAiLCJvcmRlcmVkVmVydGljZXNGcm9tVmVydGV4TWFwQW5kRWRnZXMiLCJSZW1haW5pbmdFZGdlcyIsImdyYXBoIiwidmVydGV4TmFtZXMiLCJzbGljZSIsInZlcnRleE1hcEZyb21WZXJ0ZXhOYW1lc0FuZEVkZ2VzIiwiZm9yRWFjaCIsInZlcnRleE5hbWUiLCJ2ZXJ0ZXhFeGlzdHMiLCJoYXNPd25Qcm9wZXJ0eSIsInZlcnRleCIsIlZlcnRleCIsImZyb21WZXJ0ZXhOYW1lIiwiZWRnZSIsInNvdXJjZVZlcnRleE5hbWUiLCJnZXRTb3VyY2VWZXJ0ZXhOYW1lIiwidGFyZ2V0VmVydGV4TmFtZSIsImdldFRhcmdldFZlcnRleE5hbWUiLCJzb3VyY2VWZXJ0ZXhFeGlzdHMiLCJ0YXJnZXRWZXJ0ZXhFeGlzdHMiLCJzb3VyY2VWZXJ0ZXgiLCJ0YXJnZXRWZXJ0ZXgiLCJpbmNvbWluZ0VkZ2UiLCJvdXRnb2luZ0VkZ2UiLCJhZGRPdXRnb2luZ0VkZ2UiLCJhZGRJbmNvbWluZ0VkZ2UiLCJ2ZXJ0ZXhMaXRlcmFsIiwiZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCIsInNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50IiwiYW5jZXN0b3JWZXJ0ZXhOYW1lcyIsImFuY2VzdG9yVmVydGV4TmFtZSIsImFuY2VzdG9yVmVydGV4RXhpc3RzIiwiYW5jZXN0b3JWZXJ0ZXgiLCJFZGdlIiwicHVzaCIsIm9yZGVyZWRWZXJ0ZXhOYW1lcyIsInN0YXJ0aW5nVmVydGV4TmFtZXMiLCJzdGFydGluZ1ZlcnRleE5hbWVzRnJvbVZlcnRleE1hcCIsInJlbW92ZWRFZGdlcyIsInN0YXJ0aW5nVmVydGV4TmFtZXNMZW5ndGgiLCJsZW5ndGgiLCJzdGFydGluZ1ZlcnRleE5hbWUiLCJwb3AiLCJvcmRlcmVkVmVydGV4TmFtZSIsImluZGV4IiwiZWRnZVN0YXJ0aW5nIiwic3BsaWNlIiwicmVtb3ZlZEVkZ2UiLCJyZW1vdmVJbmNvbWluZ0VkZ2UiLCJ0YXJnZXRWZXJ0ZXhTdGFydGluZyIsImlzU3RhcnRpbmciLCJlZGdlc0xlbmd0aCIsInRvcG9sb2dpY2FsbHlTb3J0ZWRWZXJ0aWNlcyIsIm1hcCIsIm9yZGVyZWRWZXJ0ZXgiLCJPYmplY3QiLCJrZXlzIiwicmVkdWNlIiwidmVydGV4U3RhcnRpbmciXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7SUFFUUEsSyxHQUFvQ0MseUIsQ0FBcENELEs7SUFBT0UsTSxHQUE2QkQseUIsQ0FBN0JDLE07SUFBUUMsZ0IsR0FBcUJGLHlCLENBQXJCRSxnQjs7SUFFRkMsSztBQUNuQixpQkFBWUMsZUFBWixFQUE2QkMsY0FBN0IsRUFBNkM7QUFBQTs7QUFDM0MsU0FBS0QsZUFBTCxHQUF1QkEsZUFBdkI7QUFDQSxTQUFLQyxjQUFMLEdBQXNCQSxjQUF0QjtBQUNEOzs7O3lDQUVvQjtBQUNuQixhQUFPLEtBQUtELGVBQVo7QUFDRDs7O3dDQUVtQjtBQUNsQixhQUFPLEtBQUtDLGNBQVo7QUFDRDs7O3VDQUVrQjtBQUFFLGFBQU8sS0FBS0EsY0FBTCxDQUFvQkMsZ0JBQXBCLEVBQVA7QUFBZ0Q7Ozt1Q0FFM0NDLGMsRUFBZ0I7QUFDeEMsVUFBTUMsU0FBUyxHQUFHQywyQkFBMkIsQ0FBQ0YsY0FBRCxDQUE3QztBQUFBLFVBQ01HLEtBQUssR0FBR0MsbUNBQW1DLENBQUNKLGNBQUQsRUFBaUJDLFNBQWpCLENBRGpEO0FBQUEsVUFFTUosZUFBZSxHQUFHUSxvQ0FBb0MsQ0FB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UDtBQUNELEdBWHFCLEVBV25CLEVBWG1CLENBRDVCO0FBY0EsU0FBT0EsbUJBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgeyBhcnJheVV0aWxpdGllcyB9IGZyb20gXCJuZWNlc3NhcnlcIjtcblxuaW1wb3J0IEVkZ2UgZnJvbSBcIi4vZWRnZVwiO1xuaW1wb3J0IFZlcnRleCBmcm9tIFwiLi92ZXJ0ZXhcIjtcbmltcG9ydCBSZW1haW5pbmdFZGdlcyBmcm9tIFwiLi9yZW1haW5pbmdFZGdlc1wiO1xuXG5jb25zdCB7IGZpcnN0LCBzZWNvbmQsIGJhY2t3YXJkc0ZvckVhY2ggfSA9IGFycmF5VXRpbGl0aWVzO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBHcmFwaCB7XG4gIGNvbnN0cnVjdG9yKG9yZGVyZWRWZXJ0aWNlcywgcmVtYWluaW5nRWRnZXMpIHtcbiAgICB0aGlzLm9yZGVyZWRWZXJ0aWNlcyA9IG9yZGVyZWRWZXJ0aWNlcztcbiAgICB0aGlzLnJlbWFpbmluZ0VkZ2VzID0gcmVtYWluaW5nRWRnZXM7XG4gIH1cblxuICBnZXRPcmRlcmVkVmVydGljZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMub3JkZXJlZFZlcnRpY2VzO1xuICB9XG5cbiAgZ2V0UmVtYWluaW5nRWRnZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMucmVtYWluaW5nRWRnZXM7XG4gIH1cblxuICBhcmVDeWNsZXNQcmVzZW50KCkgeyByZXR1cm4gdGhpcy5yZW1haW5pbmdFZGdlcy5hcmVDeWNsZXNQcmVzZW50KCk7IH1cblxuICBzdGF0aWMgZnJvbVZlcnRleExpdGVyYWxzKHZlcnRleExpdGVyYWxzKSB7XG4gICAgY29uc3QgdmVydGV4TWFwID0gdmVydGV4TWFwRnJvbVZlcnRleExpdGVyYWxzKHZlcnRleExpdGVyYWxzKSxcbiAgICAgICAgICBlZGdlcyA9IGVkZ2VzRnJvbVZlcnRleExpdGVyYWxzQW5kVmVydGV4TWFwKHZlcnRleExpdGVyYWxzLCB2ZXJ0ZXhNYXApLFxuICAgICAgICAgIG9yZGVyZWRWZXJ0aWNlcyA9IG9yZGVyZWRWZXJ0aWNlc0Zyb21WZXJ0ZXhNYXBBbmRFZGdlcyh2ZXJ0ZXhNYXAsIGVkZ2VzKSxcbiAgICAgICAgICByZW1haW5pbmdFZGdlcyA9IG5ldyBSZW1haW5pbmdFZGdlcyhlZGdlcyksXG4gICAgICAgICAgZ3JhcGggPSBuZXcgR3JhcGgob3JkZXJlZFZlcnRpY2VzLCByZW1haW5pbmdFZGdlcyk7XG5cbiAgICByZXR1cm4gZ3JhcGg7XG4gIH1cblxuICBzdGF0aWMgZnJvbVZlcnRleE5hbWVzQW5kRWRnZXModmVydGV4TmFtZXMsIGVkZ2VzKSB7XG4gICAgZWRnZXMgPSBlZGdlcy5zbGljZSgpOyAgLy8vXG5cbiAgICBjb25zdCB2ZXJ0ZXhNYXAgPSB2ZXJ0ZXhNYXBGcm9tVmVydGV4TmFtZXNBbmRFZGdlcyh2ZXJ0ZXhOYW1lcywgZWRnZXMpLFxuICAgICAgICAgIG9yZGVyZWRWZXJ0aWNlcyA9IG9yZGVyZWRWZXJ0aWNlc0Zyb21WZXJ0ZXhNYXBBbmRFZGdlcyh2ZXJ0ZXhNYXAsIGVkZ2VzKSxcbiAgICAgICAgICByZW1haW5pbmdFZGdlcyA9IG5ldyBSZW1haW5pbmdFZGdlcyhlZGdlcyksXG4gICAgICAgICAgZ3JhcGggPSBuZXcgR3JhcGgob3JkZXJlZFZlcnRpY2VzLCByZW1haW5pbmdFZGdlcyk7XG5cbiAgICByZXR1cm4gZ3JhcGg7XG4gIH1cbn1cblxuZnVuY3Rpb24gdmVydGV4TWFwRnJvbVZlcnRleE5hbWVzQW5kRWRnZXModmVydGV4TmFtZXMsIGVkZ2VzKSB7XG4gIGNvbnN0IHZlcnRleE1hcCA9IHt9O1xuXG4gIHZlcnRleE5hbWVzLmZvckVhY2goKHZlcnRleE5hbWUpID0+IHtcbiAgICBjb25zdCB2ZXJ0ZXhFeGlzdHMgPSB2ZXJ0ZXhNYXAuaGFzT3duUHJvcGVydHkodmVydGV4TmFtZSk7XG5cbiAgICBpZiAoIXZlcnRleEV4aXN0cykge1xuICAgICAgY29uc3QgdmVydGV4ID0gVmVydGV4LmZyb21WZXJ0ZXhOYW1lKHZlcnRleE5hbWUpO1xuXG4gICAgICB2ZXJ0ZXhNYXBbdmVydGV4TmFtZV0gPSB2ZXJ0ZXg7XG4gICAgfVxuICB9KTtcblxuICBlZGdlcy5mb3JFYWNoKChlZGdlKSA9PiB7XG4gICAgY29uc3Qgc291cmNlVmVydGV4TmFtZSA9IGVkZ2UuZ2V0U291cmNlVmVydGV4TmFtZSgpLFxuICAgICAgICAgIHRhcmdldFZlcnRleE5hbWUgPSBlZGdlLmdldFRhcmdldFZlcnRleE5hbWUoKSxcbiAgICAgICAgICBzb3VyY2VWZXJ0ZXhFeGlzdHMgPSB2ZXJ0ZXhNYXAuaGFzT3duUHJvcGVydHkoc291cmNlVmVydGV4TmFtZSksXG4gICAgICAgICAgdGFyZ2V0VmVydGV4RXhpc3RzID0gdmVydGV4TWFwLmhhc093blByb3BlcnR5KHRhcmdldFZlcnRleE5hbWUpO1xuXG4gICAgaWYgKCFzb3VyY2VWZXJ0ZXhFeGlzdHMpIHtcbiAgICAgIGNvbnN0IHNvdXJjZVZlcnRleCA9IFZlcnRleC5mcm9tVmVydGV4TmFtZShzb3VyY2VWZXJ0ZXhOYW1lKTtcblxuICAgICAgdmVydGV4TWFwW3NvdXJjZVZlcnRleE5hbWVdID0gc291cmNlVmVydGV4O1xuICAgIH1cblxuICAgIGlmICghdGFyZ2V0VmVydGV4RXhpc3RzKSB7XG4gICAgICBjb25zdCB0YXJnZXRWZXJ0ZXggPSBWZXJ0ZXguZnJvbVZlcnRleE5hbWUodGFyZ2V0VmVydGV4TmFtZSk7XG5cbiAgICAgIHZlcnRleE1hcFt0YXJnZXRWZXJ0ZXhOYW1lXSA9IHRhcmdldFZlcnRleDtcbiAgICB9XG5cbiAgICBjb25zdCBzb3VyY2VWZXJ0ZXggPSB2ZXJ0ZXhNYXBbc291cmNlVmVydGV4TmFtZV0sXG4gICAgICAgICAgdGFyZ2V0VmVydGV4ID0gdmVydGV4TWFwW3RhcmdldFZlcnRleE5hbWVdLFxuICAgICAgICAgIGluY29taW5nRWRnZSA9IGVkZ2UsICAvLy9cbiAgICAgICAgICBvdXRnb2luZ0VkZ2UgPSBlZGdlOyAgLy8vXG5cbiAgICBzb3VyY2VWZXJ0ZXguYWRkT3V0Z29pbmdFZGdlKG91dGdvaW5nRWRnZSk7XG5cbiAgICB0YXJnZXRWZXJ0ZXguYWRkSW5jb21pbmdFZGdlKGluY29taW5nRWRnZSk7XG4gIH0pO1xuXG4gIHJldHVybiB2ZXJ0ZXhNYXA7XG59XG5cbmZ1bmN0aW9uIHZlcnRleE1hcEZyb21WZXJ0ZXhMaXRlcmFscyh2ZXJ0ZXhMaXRlcmFscykge1xuICBjb25zdCB2ZXJ0ZXhNYXAgPSB7fTtcblxuICB2ZXJ0ZXhMaXRlcmFscy5mb3JFYWNoKCh2ZXJ0ZXhMaXRlcmFsKSA9PiB7XG4gICAgY29uc3QgZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCA9IGZpcnN0KHZlcnRleExpdGVyYWwpLFxuICAgICAgICAgIHZlcnRleE5hbWUgPSBmaXJzdFZlcnRleExpdGVyYWxFbGVtZW50LCAvLy9cbiAgICAgICAgICB2ZXJ0ZXhFeGlzdHMgPSB2ZXJ0ZXhNYXAuaGFzT3duUHJvcGVydHkodmVydGV4TmFtZSk7XG5cbiAgICBpZiAoIXZlcnRleEV4aXN0cykge1xuICAgICAgY29uc3QgdmVydGV4ID0gVmVydGV4LmZyb21WZXJ0ZXhOYW1lKHZlcnRleE5hbWUpO1xuXG4gICAgICB2ZXJ0ZXhNYXBbdmVydGV4TmFtZV0gPSB2ZXJ0ZXg7XG4gICAgfVxuXG4gICAgY29uc3Qgc2Vjb25kVmVydGV4TGl0ZXJhbEVsZW1lbnQgPSBzZWNvbmQodmVydGV4TGl0ZXJhbCksXG4gICAgICAgICAgYW5jZXN0b3JWZXJ0ZXhOYW1lcyA9IHNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50OyAvLy9cblxuICAgIGFuY2VzdG9yVmVydGV4TmFtZXMuZm9yRWFjaCgoYW5jZXN0b3JWZXJ0ZXhOYW1lKSA9PiB7XG4gICAgICBjb25zdCBhbmNlc3RvclZlcnRleEV4aXN0cyA9IHZlcnRleE1hcC5oYXNPd25Qcm9wZXJ0eShhbmNlc3RvclZlcnRleE5hbWUpO1xuXG4gICAgICBpZiAoIWFuY2VzdG9yVmVydGV4RXhpc3RzKSB7XG4gICAgICAgIGNvbnN0IGFuY2VzdG9yVmVydGV4ID0gVmVydGV4LmZyb21WZXJ0ZXhOYW1lKGFuY2VzdG9yVmVydGV4TmFtZSk7XG5cbiAgICAgICAgdmVydGV4TWFwW2FuY2VzdG9yVmVydGV4TmFtZV0gPSBhbmNlc3RvclZlcnRleDtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG5cbiAgcmV0dXJuIHZlcnRleE1hcDtcbn1cblxuZnVuY3Rpb24gZWRnZXNGcm9tVmVydGV4TGl0ZXJhbHNBbmRWZXJ0ZXhNYXAodmVydGV4TGl0ZXJhbHMsIHZlcnRleE1hcCkge1xuICBjb25zdCBlZGdlcyA9IFtdO1xuXG4gIHZlcnRleExpdGVyYWxzLmZvckVhY2goKHZlcnRleExpdGVyYWwpID0+IHtcbiAgICBjb25zdCBmaXJzdFZlcnRleExpdGVyYWxFbGVtZW50ID0gZmlyc3QodmVydGV4TGl0ZXJhbCksXG4gICAgICAgICAgc2Vjb25kVmVydGV4TGl0ZXJhbEVsZW1lbnQgPSBzZWNvbmQodmVydGV4TGl0ZXJhbCksXG4gICAgICAgICAgYW5jZXN0b3JWZXJ0ZXhOYW1lcyA9IHNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50LCAvLy9cbiAgICAgICAgICB2ZXJ0ZXhOYW1lID0gZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudDsgLy8vXG5cbiAgICBhbmNlc3RvclZlcnRleE5hbWVzLmZvckVhY2goKGFuY2VzdG9yVmVydGV4TmFtZSkgPT4ge1xuICAgICAgY29uc3Qgc291cmNlVmVydGV4TmFtZSA9IGFuY2VzdG9yVmVydGV4TmFtZSwgLy8vXG4gICAgICAgICAgICB0YXJnZXRWZXJ0ZXhOYW1lID0gdmVydGV4TmFtZSwgIC8vL1xuICAgICAgICAgICAgc291cmNlVmVydGV4ID0gdmVydGV4TWFwW3NvdXJjZVZlcnRleE5hbWVdLFxuICAgICAgICAgICAgdGFyZ2V0VmVydGV4ID0gdmVydGV4TWFwW3RhcmdldFZlcnRleE5hbWVdLFxuICAgICAgICAgICAgZWRnZSA9IG5ldyBFZGdlKHNvdXJjZVZlcnRleE5hbWUsIHRhcmdldFZlcnRleE5hbWUpLFxuICAgICAgICAgICAgaW5jb21pbmdFZGdlID0gZWRnZSwgIC8vL1xuICAgICAgICAgICAgb3V0Z29pbmdFZGdlID0gZWRnZTsgIC8vL1xuXG4gICAgICBlZGdlcy5wdXNoKGVkZ2UpO1xuXG4gICAgICBzb3VyY2VWZXJ0ZXguYWRkT3V0Z29pbmdFZGdlKG91dGdvaW5nRWRnZSk7XG5cbiAgICAgIHRhcmdldFZlcnRleC5hZGRJbmNvbWluZ0VkZ2UoaW5jb21pbmdFZGdlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgcmV0dXJuIGVkZ2VzO1xufVxuXG5mdW5jdGlvbiBvcmRlcmVkVmVydGljZXNGcm9tVmVydGV4TWFwQW5kRWRnZXModmVydGV4TWFwLCBlZGdlcykge1xuICBjb25zdCBvcmRlcmVkVmVydGV4TmFtZXMgPSBbXSxcbiAgICAgICAgc3RhcnRpbmdWZXJ0ZXhOYW1lcyA9IHN0YXJ0aW5nVmVydGV4TmFtZXNGcm9tVmVydGV4TWFwKHZlcnRleE1hcCksXG4gICAgICAgIHJlbW92ZWRFZGdlcyA9IFtdO1xuXG4gIGxldCBzdGFydGluZ1ZlcnRleE5hbWVzTGVuZ3RoID0gc3RhcnRpbmdWZXJ0ZXhOYW1lcy5sZW5ndGg7XG5cbiAgd2hpbGUgKHN0YXJ0aW5nVmVydGV4TmFtZXNMZW5ndGggPiAwKSB7XG4gICAgY29uc3Qgc3RhcnRpbmdWZXJ0ZXhOYW1lID0gc3RhcnRpbmdWZXJ0ZXhOYW1lcy5wb3AoKSxcbiAgICAgICAgICBvcmRlcmVkVmVydGV4TmFtZSA9IHN0YXJ0aW5nVmVydGV4TmFtZTsgIC8vL1xuXG4gICAgb3JkZXJlZFZlcnRleE5hbWVzLnB1c2gob3JkZXJlZFZlcnRleE5hbWUpO1xuXG4gICAgYmFja3dhcmRzRm9yRWFjaChlZGdlcywgKGVkZ2UsIGluZGV4KSA9PiB7XG4gICAgICBjb25zdCBzb3VyY2VWZXJ0ZXhOYW1lID0gZWRnZS5nZXRTb3VyY2VWZXJ0ZXhOYW1lKCksXG4gICAgICAgICAgICBlZGdlU3RhcnRpbmcgPSAoc291cmNlVmVydGV4TmFtZSA9PT0gc3RhcnRpbmdWZXJ0ZXhOYW1lKTsgLy8vXG5cbiAgICAgIGlmIChlZGdlU3RhcnRpbmcpIHtcbiAgICAgICAgZWRnZXMuc3BsaWNlKGluZGV4LCAxKTtcblxuICAgICAgICBjb25zdCB0YXJnZXRWZXJ0ZXhOYW1lID0gZWRnZS5nZXRUYXJnZXRWZXJ0ZXhOYW1lKCksXG4gICAgICAgICAgICAgIHRhcmdldFZlcnRleCA9IHZlcnRleE1hcFt0YXJnZXRWZXJ0ZXhOYW1lXSxcbiAgICAgICAgICAgICAgaW5jb21pbmdFZGdlID0gZWRnZSwgLy8vXG4gICAgICAgICAgICAgIHJlbW92ZWRFZGdlID0gZWRnZTsgIC8vL1xuXG4gICAgICAgIHRhcmdldFZlcnRleC5yZW1vdmVJbmNvbWluZ0VkZ2UoaW5jb21pbmdFZGdlKTtcblxuICAgICAgICByZW1vdmVkRWRnZXMucHVzaChyZW1vdmVkRWRnZSk7XG5cbiAgICAgICAgY29uc3QgdGFyZ2V0VmVydGV4U3RhcnRpbmcgPSB0YXJnZXRWZXJ0ZXguaXNTdGFydGluZygpO1xuXG4gICAgICAgIGlmICh0YXJnZXRWZXJ0ZXhTdGFydGluZykge1xuICAgICAgICAgIGNvbnN0IHN0YXJ0aW5nVmVydGV4TmFtZSA9IHRhcmdldFZlcnRleE5hbWU7ICAvLy9cblxuICAgICAgICAgIHN0YXJ0aW5nVmVydGV4TmFtZXMucHVzaChzdGFydGluZ1ZlcnRleE5hbWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBzdGFydGluZ1ZlcnRleE5hbWVzTGVuZ3RoID0gc3RhcnRpbmdWZXJ0ZXhOYW1lcy5sZW5ndGg7XG4gIH1cblxuICBjb25zdCBlZGdlc0xlbmd0aCA9IGVkZ2VzLmxlbmd0aDtcblxuICBpZiAoZWRnZXNMZW5ndGggPT09IDApIHtcbiAgICByZW1vdmVkRWRnZXMuZm9yRWFjaCgocmVtb3ZlZEVkZ2UpID0+IHtcbiAgICAgIGNvbnN0IHRhcmdldFZlcnRleE5hbWUgPSByZW1vdmVkRWRnZS5nZXRUYXJnZXRWZXJ0ZXhOYW1lKCksXG4gICAgICAgICAgICB0YXJnZXRWZXJ0ZXggPSB2ZXJ0ZXhNYXBbdGFyZ2V0VmVydGV4TmFtZV0sXG4gICAgICAgICAgICBpbmNvbWluZ0VkZ2UgPSByZW1vdmVkRWRnZTsgLy8vXG4gICAgICBcbiAgICAgIHRhcmdldFZlcnRleC5hZGRJbmNvbWluZ0VkZ2UoaW5jb21pbmdFZGdlKTtcbiAgICB9KVxuICB9XG5cbiAgY29uc3QgdG9wb2xvZ2ljYWxseVNvcnRlZFZlcnRpY2VzID0gb3JkZXJlZFZlcnRleE5hbWVzLm1hcCgob3JkZXJlZFZlcnRleE5hbWUpID0+IHtcbiAgICBjb25zdCBvcmRlcmVkVmVydGV4ID0gdmVydGV4TWFwW29yZGVyZWRWZXJ0ZXhOYW1lXTtcblxuICAgIHJldHVybiBvcmRlcmVkVmVydGV4O1xuICB9KTtcblxuICByZXR1cm4gdG9wb2xvZ2ljYWxseVNvcnRlZFZlcnRpY2VzO1xufVxuXG5mdW5jdGlvbiBzdGFydGluZ1ZlcnRleE5hbWVzRnJvbVZlcnRleE1hcCh2ZXJ0ZXhNYXApIHtcbiAgY29uc3QgdmVydGV4TmFtZXMgPSBPYmplY3Qua2V5cyh2ZXJ0ZXhNYXApLFxuICAgICAgICBzdGFydGluZ1ZlcnRleE5hbWVzID0gdmVydGV4TmFtZXMucmVkdWNlKChzdGFydGluZ1ZlcnRleE5hbWVzLCB2ZXJ0ZXhOYW1lKSA9PiB7XG4gICAgICAgICAgY29uc3QgdmVydGV4ID0gdmVydGV4TWFwW3ZlcnRleE5hbWVdLFxuICAgICAgICAgICAgICAgIHZlcnRleFN0YXJ0aW5nID0gdmVydGV4LmlzU3RhcnRpbmcoKTtcblxuICAgICAgICAgIGlmICh2ZXJ0ZXhTdGFydGluZykge1xuICAgICAgICAgICAgY29uc3Qgc3RhcnRpbmdWZXJ0ZXhOYW1lID0gdmVydGV4TmFtZTsgIC8vL1xuXG4gICAgICAgICAgICBzdGFydGluZ1ZlcnRleE5hbWVzLnB1c2goc3RhcnRpbmdWZXJ0ZXhOYW1lKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gc3RhcnRpbmdWZXJ0ZXhOYW1lc1xuICAgICAgICB9LCBbXSk7XG5cbiAgcmV0dXJuIHN0YXJ0aW5nVmVydGV4TmFtZXM7XG59XG4iXX0=