'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var necessary = require('necessary');

var Edge = require('./graph/edge'),
    Vertex = require('./graph/vertex'),
    RemainingEdges = require('./graph/remainingEdges');

var array = necessary.array;

var Graph = function () {
  function Graph(topologicallyOrderedVertices, remainingEdges) {
    _classCallCheck(this, Graph);

    this.topologicallyOrderedVertices = topologicallyOrderedVertices;
    this.remainingEdges = remainingEdges;
  }

  _createClass(Graph, [{
    key: 'getTopologicallyOrderedVertices',
    value: function getTopologicallyOrderedVertices() {
      return this.topologicallyOrderedVertices;
    }
  }, {
    key: 'getRemainingEdges',
    value: function getRemainingEdges() {
      return this.remainingEdges;
    }
  }, {
    key: 'areCyclesPresent',
    value: function areCyclesPresent() {
      return this.remainingEdges.areCyclesPresent();
    }
  }], [{
    key: 'fromVertexNamesAndEdges',
    value: function fromVertexNamesAndEdges(vertexNames, edges) {
      var vertexMap = vertexMapFromVertexNamesAndEdges(vertexNames, edges),
          topologicallyOrderedVertices = topologicallyOrderedVerticesFromVertexMapAndEdges(vertexMap, edges),
          remainingEdges = new RemainingEdges(edges),
          graph = new Graph(topologicallyOrderedVertices, remainingEdges);

      return graph;
    }
  }, {
    key: 'fromVertexLiterals',
    value: function fromVertexLiterals(vertexLiterals) {
      var vertexMap = vertexMapFromVertexLiterals(vertexLiterals),
          edges = edgesFromVertexLiteralsAndVertexMap(vertexLiterals, vertexMap),
          topologicallyOrderedVertices = topologicallyOrderedVerticesFromVertexMapAndEdges(vertexMap, edges),
          remainingEdges = new RemainingEdges(edges),
          graph = new Graph(topologicallyOrderedVertices, remainingEdges);

      return graph;
    }
  }]);

  return Graph;
}();

module.exports = Graph;

function vertexMapFromVertexNamesAndEdges(vertexNames, edges) {
  var vertexMap = {};

  vertexNames.forEach(function (vertexName) {
    var vertexExists = vertexMap.hasOwnProperty(vertexName);

    if (!vertexExists) {
      var vertex = Vertex.fromVertexName(vertexName);

      vertexMap[vertexName] = vertex;
    }
  });

  edges.forEach(function (edge) {
    var sourceVertexName = edge.getSourceVertexName(),
        targetVertexName = edge.getTargetVertexName(),
        sourceVertexExists = vertexMap.hasOwnProperty(sourceVertexName),
        targetVertexExists = vertexMap.hasOwnProperty(targetVertexName);

    if (!sourceVertexExists) {
      var _sourceVertex = Vertex.fromVertexName(sourceVertexName);

      vertexMap[sourceVertexName] = _sourceVertex;
    }

    if (!targetVertexExists) {
      var _targetVertex = Vertex.fromVertexName(targetVertexName);

      vertexMap[targetVertexName] = _targetVertex;
    }

    var sourceVertex = vertexMap[sourceVertexName],
        targetVertex = vertexMap[targetVertexName],
        incomingEdge = edge,
        ///
    outgoingEdge = edge; ///

    sourceVertex.addOutgoingEdge(outgoingEdge);

    targetVertex.addIncomingEdge(incomingEdge);
  });

  return vertexMap;
}

function vertexMapFromVertexLiterals(vertexLiterals) {
  var vertexMap = {};

  vertexLiterals.forEach(function (vertexLiteral) {
    var firstVertexLiteralElement = array.first(vertexLiteral),
        vertexName = firstVertexLiteralElement,
        ///
    vertexExists = vertexMap.hasOwnProperty(vertexName);

    if (!vertexExists) {
      var vertex = Vertex.fromVertexName(vertexName);

      vertexMap[vertexName] = vertex;
    }

    var secondVertexLiteralElement = array.second(vertexLiteral),
        ancestorVertexNames = secondVertexLiteralElement; ///

    ancestorVertexNames.forEach(function (ancestorVertexName) {
      var ancestorVertexExists = vertexMap.hasOwnProperty(ancestorVertexName);

      if (!ancestorVertexExists) {
        var ancestorVertex = Vertex.fromVertexName(ancestorVertexName);

        vertexMap[ancestorVertexName] = ancestorVertex;
      }
    });
  });

  return vertexMap;
}

function edgesFromVertexLiteralsAndVertexMap(vertexLiterals, vertexMap) {
  var edges = [];

  vertexLiterals.forEach(function (vertexLiteral) {
    var firstVertexLiteralElement = array.first(vertexLiteral),
        secondVertexLiteralElement = array.second(vertexLiteral),
        ancestorVertexNames = secondVertexLiteralElement,
        ///
    vertexName = firstVertexLiteralElement; ///

    ancestorVertexNames.forEach(function (ancestorVertexName) {
      var sourceVertexName = ancestorVertexName,
          ///
      targetVertexName = vertexName,
          ///
      sourceVertex = vertexMap[sourceVertexName],
          targetVertex = vertexMap[targetVertexName],
          edge = new Edge(sourceVertexName, targetVertexName),
          incomingEdge = edge,
          ///
      outgoingEdge = edge; ///

      edges.push(edge);

      sourceVertex.addOutgoingEdge(outgoingEdge);

      targetVertex.addIncomingEdge(incomingEdge);
    });
  });

  return edges;
}

function topologicallyOrderedVerticesFromVertexMapAndEdges(vertexMap, edges) {
  var topologicallyOrderedVertexNames = [],
      startingVertexNames = startingVertexNamesFromVertexMap(vertexMap),
      removedEdges = [];

  var startingVertexNamesLength = startingVertexNames.length;

  var _loop = function _loop() {
    var startingVertexName = startingVertexNames.pop(),
        topologicallyOrderedVertexName = startingVertexName; ///

    topologicallyOrderedVertexNames.push(topologicallyOrderedVertexName);

    array.backwardsForEach(edges, function (edge, index) {
      var sourceVertexName = edge.getSourceVertexName(),
          edgeStarting = sourceVertexName === startingVertexName; ///

      if (edgeStarting) {
        edges.splice(index, 1);

        var targetVertexName = edge.getTargetVertexName(),
            targetVertex = vertexMap[targetVertexName],
            incomingEdge = edge,
            ///
        removedEdge = edge; ///

        targetVertex.removeIncomingEdge(incomingEdge);

        removedEdges.push(removedEdge);

        var targetVertexStarting = targetVertex.isStarting();

        if (targetVertexStarting) {
          var _startingVertexName = targetVertexName; ///

          startingVertexNames.push(_startingVertexName);
        }
      }
    });

    startingVertexNamesLength = startingVertexNames.length;
  };

  while (startingVertexNamesLength > 0) {
    _loop();
  }

  var edgesLength = edges.length;

  if (edgesLength === 0) {
    removedEdges.forEach(function (removedEdge) {
      var targetVertexName = removedEdge.getTargetVertexName(),
          targetVertex = vertexMap[targetVertexName],
          incomingEdge = removedEdge; ///

      targetVertex.addIncomingEdge(incomingEdge);
    });
  }

  var topologicallySortedVertices = topologicallyOrderedVertexNames.map(function (topologicallyOrderedVertexName) {
    var topologicallyOrderedVertex = vertexMap[topologicallyOrderedVertexName];

    return topologicallyOrderedVertex;
  });

  return topologicallySortedVertices;
}

function startingVertexNamesFromVertexMap(vertexMap) {
  var vertexNames = Object.keys(vertexMap),
      startingVertexNames = vertexNames.reduce(function (startingVertexNames, vertexName) {
    var vertex = vertexMap[vertexName],
        vertexStarting = vertex.isStarting();

    if (vertexStarting) {
      var _startingVertexName2 = vertexName; ///

      startingVertexNames.push(_startingVertexName2);
    }

    return startingVertexNames;
  }, []);

  return startingVertexNames;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9ncmFwaC5qcyJdLCJuYW1lcyI6WyJuZWNlc3NhcnkiLCJyZXF1aXJlIiwiRWRnZSIsIlZlcnRleCIsIlJlbWFpbmluZ0VkZ2VzIiwiYXJyYXkiLCJHcmFwaCIsInRvcG9sb2dpY2FsbHlPcmRlcmVkVmVydGljZXMiLCJyZW1haW5pbmdFZGdlcyIsImFyZUN5Y2xlc1ByZXNlbnQiLCJ2ZXJ0ZXhOYW1lcyIsImVkZ2VzIiwidmVydGV4TWFwIiwidmVydGV4TWFwRnJvbVZlcnRleE5hbWVzQW5kRWRnZXMiLCJ0b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRpY2VzRnJvbVZlcnRleE1hcEFuZEVkZ2VzIiwiZ3JhcGgiLCJ2ZXJ0ZXhMaXRlcmFscyIsInZlcnRleE1hcEZyb21WZXJ0ZXhMaXRlcmFscyIsImVkZ2VzRnJvbVZlcnRleExpdGVyYWxzQW5kVmVydGV4TWFwIiwibW9kdWxlIiwiZXhwb3J0cyIsImZvckVhY2giLCJ2ZXJ0ZXhOYW1lIiwidmVydGV4RXhpc3RzIiwiaGFzT3duUHJvcGVydHkiLCJ2ZXJ0ZXgiLCJmcm9tVmVydGV4TmFtZSIsImVkZ2UiLCJzb3VyY2VWZXJ0ZXhOYW1lIiwiZ2V0U291cmNlVmVydGV4TmFtZSIsInRhcmdldFZlcnRleE5hbWUiLCJnZXRUYXJnZXRWZXJ0ZXhOYW1lIiwic291cmNlVmVydGV4RXhpc3RzIiwidGFyZ2V0VmVydGV4RXhpc3RzIiwic291cmNlVmVydGV4IiwidGFyZ2V0VmVydGV4IiwiaW5jb21pbmdFZGdlIiwib3V0Z29pbmdFZGdlIiwiYWRkT3V0Z29pbmdFZGdlIiwiYWRkSW5jb21pbmdFZGdlIiwidmVydGV4TGl0ZXJhbCIsImZpcnN0VmVydGV4TGl0ZXJhbEVsZW1lbnQiLCJmaXJzdCIsInNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50Iiwic2Vjb25kIiwiYW5jZXN0b3JWZXJ0ZXhOYW1lcyIsImFuY2VzdG9yVmVydGV4TmFtZSIsImFuY2VzdG9yVmVydGV4RXhpc3RzIiwiYW5jZXN0b3JWZXJ0ZXgiLCJwdXNoIiwidG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0ZXhOYW1lcyIsInN0YXJ0aW5nVmVydGV4TmFtZXMiLCJzdGFydGluZ1ZlcnRleE5hbWVzRnJvbVZlcnRleE1hcCIsInJlbW92ZWRFZGdlcyIsInN0YXJ0aW5nVmVydGV4TmFtZXNMZW5ndGgiLCJsZW5ndGgiLCJzdGFydGluZ1ZlcnRleE5hbWUiLCJwb3AiLCJ0b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRleE5hbWUiLCJiYWNrd2FyZHNGb3JFYWNoIiwiaW5kZXgiLCJlZGdlU3RhcnRpbmciLCJzcGxpY2UiLCJyZW1vdmVkRWRnZSIsInJlbW92ZUluY29taW5nRWRnZSIsInRhcmdldFZlcnRleFN0YXJ0aW5nIiwiaXNTdGFydGluZyIsImVkZ2VzTGVuZ3RoIiwidG9wb2xvZ2ljYWxseVNvcnRlZFZlcnRpY2VzIiwibWFwIiwidG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0ZXgiLCJPYmplY3QiLCJrZXlzIiwicmVkdWNlIiwidmVydGV4U3RhcnRpbmciXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUFFQSxJQUFNQSxZQUFZQyxRQUFRLFdBQVIsQ0FBbEI7O0FBRUEsSUFBTUMsT0FBT0QsUUFBUSxjQUFSLENBQWI7QUFBQSxJQUNNRSxTQUFTRixRQUFRLGdCQUFSLENBRGY7QUFBQSxJQUVNRyxpQkFBaUJILFFBQVEsd0JBQVIsQ0FGdkI7O0lBSVFJLEssR0FBVUwsUyxDQUFWSyxLOztJQUVGQyxLO0FBQ0osaUJBQWFDLDRCQUFiLEVBQTJDQyxjQUEzQyxFQUEyRDtBQUFBOztBQUN6RCxTQUFLRCw0QkFBTCxHQUFvQ0EsNEJBQXBDO0FBQ0EsU0FBS0MsY0FBTCxHQUFzQkEsY0FBdEI7QUFDRDs7OztzREFFaUM7QUFDaEMsYUFBTyxLQUFLRCw0QkFBWjtBQUNEOzs7d0NBRW1CO0FBQ2xCLGFBQU8sS0FBS0MsY0FBWjtBQUNEOzs7dUNBRWtCO0FBQUUsYUFBTyxLQUFLQSxjQUFMLENBQW9CQyxnQkFBcEIsRUFBUDtBQUFnRDs7OzRDQUV0Q0MsVyxF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c0J6QyxZQUFZK0QsTUFBWixDQUFtQixVQUFTdEIsbUJBQVQsRUFBOEI3QixVQUE5QixFQUEwQztBQUNqRixRQUFNRyxTQUFTYixVQUFVVSxVQUFWLENBQWY7QUFBQSxRQUNNb0QsaUJBQWlCakQsT0FBT3lDLFVBQVAsRUFEdkI7O0FBR0EsUUFBSVEsY0FBSixFQUFvQjtBQUNsQixVQUFNbEIsdUJBQXFCbEMsVUFBM0IsQ0FEa0IsQ0FDc0I7O0FBRXhDNkIsMEJBQW9CRixJQUFwQixDQUF5Qk8sb0JBQXpCO0FBQ0Q7O0FBRUQsV0FBT0wsbUJBQVA7QUFDRCxHQVhxQixFQVduQixFQVhtQixDQUQ1Qjs7QUFjQSxTQUFPQSxtQkFBUDtBQUNEIiwiZmlsZSI6ImdyYXBoLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBuZWNlc3NhcnkgPSByZXF1aXJlKCduZWNlc3NhcnknKTtcblxuY29uc3QgRWRnZSA9IHJlcXVpcmUoJy4vZ3JhcGgvZWRnZScpLFxuICAgICAgVmVydGV4ID0gcmVxdWlyZSgnLi9ncmFwaC92ZXJ0ZXgnKSxcbiAgICAgIFJlbWFpbmluZ0VkZ2VzID0gcmVxdWlyZSgnLi9ncmFwaC9yZW1haW5pbmdFZGdlcycpO1xuXG5jb25zdCB7IGFycmF5IH0gPSBuZWNlc3Nhcnk7XG5cbmNsYXNzIEdyYXBoIHtcbiAgY29uc3RydWN0b3IgKHRvcG9sb2dpY2FsbHlPcmRlcmVkVmVydGljZXMsIHJlbWFpbmluZ0VkZ2VzKSB7XG4gICAgdGhpcy50b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRpY2VzID0gdG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0aWNlcztcbiAgICB0aGlzLnJlbWFpbmluZ0VkZ2VzID0gcmVtYWluaW5nRWRnZXM7XG4gIH1cblxuICBnZXRUb3BvbG9naWNhbGx5T3JkZXJlZFZlcnRpY2VzKCkge1xuICAgIHJldHVybiB0aGlzLnRvcG9sb2dpY2FsbHlPcmRlcmVkVmVydGljZXM7XG4gIH1cblxuICBnZXRSZW1haW5pbmdFZGdlcygpIHtcbiAgICByZXR1cm4gdGhpcy5yZW1haW5pbmdFZGdlcztcbiAgfVxuXG4gIGFyZUN5Y2xlc1ByZXNlbnQoKSB7IHJldHVybiB0aGlzLnJlbWFpbmluZ0VkZ2VzLmFyZUN5Y2xlc1ByZXNlbnQoKTsgfVxuXG4gIHN0YXRpYyBmcm9tVmVydGV4TmFtZXNBbmRFZGdlcyh2ZXJ0ZXhOYW1lcywgZWRnZXMpIHtcbiAgICBjb25zdCB2ZXJ0ZXhNYXAgPSB2ZXJ0ZXhNYXBGcm9tVmVydGV4TmFtZXNBbmRFZGdlcyh2ZXJ0ZXhOYW1lcywgZWRnZXMpLFxuICAgICAgICAgIHRvcG9sb2dpY2FsbHlPcmRlcmVkVmVydGljZXMgPSB0b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRpY2VzRnJvbVZlcnRleE1hcEFuZEVkZ2VzKHZlcnRleE1hcCwgZWRnZXMpLFxuICAgICAgICAgIHJlbWFpbmluZ0VkZ2VzID0gbmV3IFJlbWFpbmluZ0VkZ2VzKGVkZ2VzKSxcbiAgICAgICAgICBncmFwaCA9IG5ldyBHcmFwaCh0b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRpY2VzLCByZW1haW5pbmdFZGdlcyk7XG5cbiAgICByZXR1cm4gZ3JhcGg7XG4gIH1cblxuICBzdGF0aWMgZnJvbVZlcnRleExpdGVyYWxzKHZlcnRleExpdGVyYWxzKSB7XG4gICAgY29uc3QgdmVydGV4TWFwID0gdmVydGV4TWFwRnJvbVZlcnRleExpdGVyYWxzKHZlcnRleExpdGVyYWxzKSxcbiAgICAgICAgICBlZGdlcyA9IGVkZ2VzRnJvbVZlcnRleExpdGVyYWxzQW5kVmVydGV4TWFwKHZlcnRleExpdGVyYWxzLCB2ZXJ0ZXhNYXApLFxuICAgICAgICAgIHRvcG9sb2dpY2FsbHlPcmRlcmVkVmVydGljZXMgPSB0b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRpY2VzRnJvbVZlcnRleE1hcEFuZEVkZ2VzKHZlcnRleE1hcCwgZWRnZXMpLFxuICAgICAgICAgIHJlbWFpbmluZ0VkZ2VzID0gbmV3IFJlbWFpbmluZ0VkZ2VzKGVkZ2VzKSxcbiAgICAgICAgICBncmFwaCA9IG5ldyBHcmFwaCh0b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRpY2VzLCByZW1haW5pbmdFZGdlcyk7XG5cbiAgICByZXR1cm4gZ3JhcGg7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBHcmFwaDtcblxuZnVuY3Rpb24gdmVydGV4TWFwRnJvbVZlcnRleE5hbWVzQW5kRWRnZXModmVydGV4TmFtZXMsIGVkZ2VzKSB7XG4gIGNvbnN0IHZlcnRleE1hcCA9IHt9O1xuXG4gIHZlcnRleE5hbWVzLmZvckVhY2goZnVuY3Rpb24odmVydGV4TmFtZSkge1xuICAgIGNvbnN0IHZlcnRleEV4aXN0cyA9IHZlcnRleE1hcC5oYXNPd25Qcm9wZXJ0eSh2ZXJ0ZXhOYW1lKTtcblxuICAgIGlmICghdmVydGV4RXhpc3RzKSB7XG4gICAgICBjb25zdCB2ZXJ0ZXggPSBWZXJ0ZXguZnJvbVZlcnRleE5hbWUodmVydGV4TmFtZSk7XG5cbiAgICAgIHZlcnRleE1hcFt2ZXJ0ZXhOYW1lXSA9IHZlcnRleDtcbiAgICB9XG4gIH0pO1xuXG4gIGVkZ2VzLmZvckVhY2goZnVuY3Rpb24oZWRnZSkge1xuICAgIGNvbnN0IHNvdXJjZVZlcnRleE5hbWUgPSBlZGdlLmdldFNvdXJjZVZlcnRleE5hbWUoKSxcbiAgICAgICAgICB0YXJnZXRWZXJ0ZXhOYW1lID0gZWRnZS5nZXRUYXJnZXRWZXJ0ZXhOYW1lKCksXG4gICAgICAgICAgc291cmNlVmVydGV4RXhpc3RzID0gdmVydGV4TWFwLmhhc093blByb3BlcnR5KHNvdXJjZVZlcnRleE5hbWUpLFxuICAgICAgICAgIHRhcmdldFZlcnRleEV4aXN0cyA9IHZlcnRleE1hcC5oYXNPd25Qcm9wZXJ0eSh0YXJnZXRWZXJ0ZXhOYW1lKTtcblxuICAgIGlmICghc291cmNlVmVydGV4RXhpc3RzKSB7XG4gICAgICBjb25zdCBzb3VyY2VWZXJ0ZXggPSBWZXJ0ZXguZnJvbVZlcnRleE5hbWUoc291cmNlVmVydGV4TmFtZSk7XG5cbiAgICAgIHZlcnRleE1hcFtzb3VyY2VWZXJ0ZXhOYW1lXSA9IHNvdXJjZVZlcnRleDtcbiAgICB9XG5cbiAgICBpZiAoIXRhcmdldFZlcnRleEV4aXN0cykge1xuICAgICAgY29uc3QgdGFyZ2V0VmVydGV4ID0gVmVydGV4LmZyb21WZXJ0ZXhOYW1lKHRhcmdldFZlcnRleE5hbWUpO1xuXG4gICAgICB2ZXJ0ZXhNYXBbdGFyZ2V0VmVydGV4TmFtZV0gPSB0YXJnZXRWZXJ0ZXg7XG4gICAgfVxuXG4gICAgY29uc3Qgc291cmNlVmVydGV4ID0gdmVydGV4TWFwW3NvdXJjZVZlcnRleE5hbWVdLFxuICAgICAgICAgIHRhcmdldFZlcnRleCA9IHZlcnRleE1hcFt0YXJnZXRWZXJ0ZXhOYW1lXSxcbiAgICAgICAgICBpbmNvbWluZ0VkZ2UgPSBlZGdlLCAgLy8vXG4gICAgICAgICAgb3V0Z29pbmdFZGdlID0gZWRnZTsgIC8vL1xuXG4gICAgc291cmNlVmVydGV4LmFkZE91dGdvaW5nRWRnZShvdXRnb2luZ0VkZ2UpO1xuXG4gICAgdGFyZ2V0VmVydGV4LmFkZEluY29taW5nRWRnZShpbmNvbWluZ0VkZ2UpO1xuICB9KTtcblxuICByZXR1cm4gdmVydGV4TWFwO1xufVxuXG5mdW5jdGlvbiB2ZXJ0ZXhNYXBGcm9tVmVydGV4TGl0ZXJhbHModmVydGV4TGl0ZXJhbHMpIHtcbiAgY29uc3QgdmVydGV4TWFwID0ge307XG5cbiAgdmVydGV4TGl0ZXJhbHMuZm9yRWFjaChmdW5jdGlvbih2ZXJ0ZXhMaXRlcmFsKSB7XG4gICAgY29uc3QgZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCA9IGFycmF5LmZpcnN0KHZlcnRleExpdGVyYWwpLFxuICAgICAgICAgIHZlcnRleE5hbWUgPSBmaXJzdFZlcnRleExpdGVyYWxFbGVtZW50LCAvLy9cbiAgICAgICAgICB2ZXJ0ZXhFeGlzdHMgPSB2ZXJ0ZXhNYXAuaGFzT3duUHJvcGVydHkodmVydGV4TmFtZSk7XG5cbiAgICBpZiAoIXZlcnRleEV4aXN0cykge1xuICAgICAgY29uc3QgdmVydGV4ID0gVmVydGV4LmZyb21WZXJ0ZXhOYW1lKHZlcnRleE5hbWUpO1xuXG4gICAgICB2ZXJ0ZXhNYXBbdmVydGV4TmFtZV0gPSB2ZXJ0ZXg7XG4gICAgfVxuXG4gICAgY29uc3Qgc2Vjb25kVmVydGV4TGl0ZXJhbEVsZW1lbnQgPSBhcnJheS5zZWNvbmQodmVydGV4TGl0ZXJhbCksXG4gICAgICAgICAgYW5jZXN0b3JWZXJ0ZXhOYW1lcyA9IHNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50OyAvLy9cblxuICAgIGFuY2VzdG9yVmVydGV4TmFtZXMuZm9yRWFjaChmdW5jdGlvbihhbmNlc3RvclZlcnRleE5hbWUpIHtcbiAgICAgIGNvbnN0IGFuY2VzdG9yVmVydGV4RXhpc3RzID0gdmVydGV4TWFwLmhhc093blByb3BlcnR5KGFuY2VzdG9yVmVydGV4TmFtZSk7XG5cbiAgICAgIGlmICghYW5jZXN0b3JWZXJ0ZXhFeGlzdHMpIHtcbiAgICAgICAgY29uc3QgYW5jZXN0b3JWZXJ0ZXggPSBWZXJ0ZXguZnJvbVZlcnRleE5hbWUoYW5jZXN0b3JWZXJ0ZXhOYW1lKTtcblxuICAgICAgICB2ZXJ0ZXhNYXBbYW5jZXN0b3JWZXJ0ZXhOYW1lXSA9IGFuY2VzdG9yVmVydGV4O1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gdmVydGV4TWFwO1xufVxuXG5mdW5jdGlvbiBlZGdlc0Zyb21WZXJ0ZXhMaXRlcmFsc0FuZFZlcnRleE1hcCh2ZXJ0ZXhMaXRlcmFscywgdmVydGV4TWFwKSB7XG4gIGNvbnN0IGVkZ2VzID0gW107XG5cbiAgdmVydGV4TGl0ZXJhbHMuZm9yRWFjaChmdW5jdGlvbih2ZXJ0ZXhMaXRlcmFsKSB7XG4gICAgY29uc3QgZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCA9IGFycmF5LmZpcnN0KHZlcnRleExpdGVyYWwpLFxuICAgICAgICAgIHNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50ID0gYXJyYXkuc2Vjb25kKHZlcnRleExpdGVyYWwpLFxuICAgICAgICAgIGFuY2VzdG9yVmVydGV4TmFtZXMgPSBzZWNvbmRWZXJ0ZXhMaXRlcmFsRWxlbWVudCwgLy8vXG4gICAgICAgICAgdmVydGV4TmFtZSA9IGZpcnN0VmVydGV4TGl0ZXJhbEVsZW1lbnQ7IC8vL1xuXG4gICAgYW5jZXN0b3JWZXJ0ZXhOYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKGFuY2VzdG9yVmVydGV4TmFtZSkge1xuICAgICAgY29uc3Qgc291cmNlVmVydGV4TmFtZSA9IGFuY2VzdG9yVmVydGV4TmFtZSwgLy8vXG4gICAgICAgICAgICB0YXJnZXRWZXJ0ZXhOYW1lID0gdmVydGV4TmFtZSwgIC8vL1xuICAgICAgICAgICAgc291cmNlVmVydGV4ID0gdmVydGV4TWFwW3NvdXJjZVZlcnRleE5hbWVdLFxuICAgICAgICAgICAgdGFyZ2V0VmVydGV4ID0gdmVydGV4TWFwW3RhcmdldFZlcnRleE5hbWVdLFxuICAgICAgICAgICAgZWRnZSA9IG5ldyBFZGdlKHNvdXJjZVZlcnRleE5hbWUsIHRhcmdldFZlcnRleE5hbWUpLFxuICAgICAgICAgICAgaW5jb21pbmdFZGdlID0gZWRnZSwgIC8vL1xuICAgICAgICAgICAgb3V0Z29pbmdFZGdlID0gZWRnZTsgIC8vL1xuXG4gICAgICBlZGdlcy5wdXNoKGVkZ2UpO1xuXG4gICAgICBzb3VyY2VWZXJ0ZXguYWRkT3V0Z29pbmdFZGdlKG91dGdvaW5nRWRnZSk7XG5cbiAgICAgIHRhcmdldFZlcnRleC5hZGRJbmNvbWluZ0VkZ2UoaW5jb21pbmdFZGdlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgcmV0dXJuIGVkZ2VzO1xufVxuXG5mdW5jdGlvbiB0b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRpY2VzRnJvbVZlcnRleE1hcEFuZEVkZ2VzKHZlcnRleE1hcCwgZWRnZXMpIHtcbiAgY29uc3QgdG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0ZXhOYW1lcyA9IFtdLFxuICAgICAgICBzdGFydGluZ1ZlcnRleE5hbWVzID0gc3RhcnRpbmdWZXJ0ZXhOYW1lc0Zyb21WZXJ0ZXhNYXAodmVydGV4TWFwKSxcbiAgICAgICAgcmVtb3ZlZEVkZ2VzID0gW107XG5cbiAgbGV0IHN0YXJ0aW5nVmVydGV4TmFtZXNMZW5ndGggPSBzdGFydGluZ1ZlcnRleE5hbWVzLmxlbmd0aDtcblxuICB3aGlsZSAoc3RhcnRpbmdWZXJ0ZXhOYW1lc0xlbmd0aCA+IDApIHtcbiAgICBjb25zdCBzdGFydGluZ1ZlcnRleE5hbWUgPSBzdGFydGluZ1ZlcnRleE5hbWVzLnBvcCgpLFxuICAgICAgICAgIHRvcG9sb2dpY2FsbHlPcmRlcmVkVmVydGV4TmFtZSA9IHN0YXJ0aW5nVmVydGV4TmFtZTsgIC8vL1xuXG4gICAgdG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0ZXhOYW1lcy5wdXNoKHRvcG9sb2dpY2FsbHlPcmRlcmVkVmVydGV4TmFtZSk7XG5cbiAgICBhcnJheS5iYWNrd2FyZHNGb3JFYWNoKGVkZ2VzLCBmdW5jdGlvbihlZGdlLCBpbmRleCkge1xuICAgICAgY29uc3Qgc291cmNlVmVydGV4TmFtZSA9IGVkZ2UuZ2V0U291cmNlVmVydGV4TmFtZSgpLFxuICAgICAgICAgICAgZWRnZVN0YXJ0aW5nID0gKHNvdXJjZVZlcnRleE5hbWUgPT09IHN0YXJ0aW5nVmVydGV4TmFtZSk7IC8vL1xuXG4gICAgICBpZiAoZWRnZVN0YXJ0aW5nKSB7XG4gICAgICAgIGVkZ2VzLnNwbGljZShpbmRleCwgMSk7XG5cbiAgICAgICAgY29uc3QgdGFyZ2V0VmVydGV4TmFtZSA9IGVkZ2UuZ2V0VGFyZ2V0VmVydGV4TmFtZSgpLFxuICAgICAgICAgICAgICB0YXJnZXRWZXJ0ZXggPSB2ZXJ0ZXhNYXBbdGFyZ2V0VmVydGV4TmFtZV0sXG4gICAgICAgICAgICAgIGluY29taW5nRWRnZSA9IGVkZ2UsIC8vL1xuICAgICAgICAgICAgICByZW1vdmVkRWRnZSA9IGVkZ2U7ICAvLy9cblxuICAgICAgICB0YXJnZXRWZXJ0ZXgucmVtb3ZlSW5jb21pbmdFZGdlKGluY29taW5nRWRnZSk7XG5cbiAgICAgICAgcmVtb3ZlZEVkZ2VzLnB1c2gocmVtb3ZlZEVkZ2UpO1xuXG4gICAgICAgIGNvbnN0IHRhcmdldFZlcnRleFN0YXJ0aW5nID0gdGFyZ2V0VmVydGV4LmlzU3RhcnRpbmcoKTtcblxuICAgICAgICBpZiAodGFyZ2V0VmVydGV4U3RhcnRpbmcpIHtcbiAgICAgICAgICBjb25zdCBzdGFydGluZ1ZlcnRleE5hbWUgPSB0YXJnZXRWZXJ0ZXhOYW1lOyAgLy8vXG5cbiAgICAgICAgICBzdGFydGluZ1ZlcnRleE5hbWVzLnB1c2goc3RhcnRpbmdWZXJ0ZXhOYW1lKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgc3RhcnRpbmdWZXJ0ZXhOYW1lc0xlbmd0aCA9IHN0YXJ0aW5nVmVydGV4TmFtZXMubGVuZ3RoO1xuICB9XG5cbiAgY29uc3QgZWRnZXNMZW5ndGggPSBlZGdlcy5sZW5ndGg7XG5cbiAgaWYgKGVkZ2VzTGVuZ3RoID09PSAwKSB7XG4gICAgcmVtb3ZlZEVkZ2VzLmZvckVhY2goZnVuY3Rpb24ocmVtb3ZlZEVkZ2UpIHtcbiAgICAgIGNvbnN0IHRhcmdldFZlcnRleE5hbWUgPSByZW1vdmVkRWRnZS5nZXRUYXJnZXRWZXJ0ZXhOYW1lKCksXG4gICAgICAgICAgICB0YXJnZXRWZXJ0ZXggPSB2ZXJ0ZXhNYXBbdGFyZ2V0VmVydGV4TmFtZV0sXG4gICAgICAgICAgICBpbmNvbWluZ0VkZ2UgPSByZW1vdmVkRWRnZTsgLy8vXG4gICAgICBcbiAgICAgIHRhcmdldFZlcnRleC5hZGRJbmNvbWluZ0VkZ2UoaW5jb21pbmdFZGdlKTtcbiAgICB9KVxuICB9XG5cbiAgY29uc3QgdG9wb2xvZ2ljYWxseVNvcnRlZFZlcnRpY2VzID0gdG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0ZXhOYW1lcy5tYXAoZnVuY3Rpb24odG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0ZXhOYW1lKSB7XG4gICAgY29uc3QgdG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0ZXggPSB2ZXJ0ZXhNYXBbdG9wb2xvZ2ljYWxseU9yZGVyZWRWZXJ0ZXhOYW1lXTtcblxuICAgIHJldHVybiB0b3BvbG9naWNhbGx5T3JkZXJlZFZlcnRleDtcbiAgfSk7XG5cbiAgcmV0dXJuIHRvcG9sb2dpY2FsbHlTb3J0ZWRWZXJ0aWNlcztcbn1cblxuZnVuY3Rpb24gc3RhcnRpbmdWZXJ0ZXhOYW1lc0Zyb21WZXJ0ZXhNYXAodmVydGV4TWFwKSB7XG4gIGNvbnN0IHZlcnRleE5hbWVzID0gT2JqZWN0LmtleXModmVydGV4TWFwKSxcbiAgICAgICAgc3RhcnRpbmdWZXJ0ZXhOYW1lcyA9IHZlcnRleE5hbWVzLnJlZHVjZShmdW5jdGlvbihzdGFydGluZ1ZlcnRleE5hbWVzLCB2ZXJ0ZXhOYW1lKSB7XG4gICAgICAgICAgY29uc3QgdmVydGV4ID0gdmVydGV4TWFwW3ZlcnRleE5hbWVdLFxuICAgICAgICAgICAgICAgIHZlcnRleFN0YXJ0aW5nID0gdmVydGV4LmlzU3RhcnRpbmcoKTtcblxuICAgICAgICAgIGlmICh2ZXJ0ZXhTdGFydGluZykge1xuICAgICAgICAgICAgY29uc3Qgc3RhcnRpbmdWZXJ0ZXhOYW1lID0gdmVydGV4TmFtZTsgIC8vL1xuXG4gICAgICAgICAgICBzdGFydGluZ1ZlcnRleE5hbWVzLnB1c2goc3RhcnRpbmdWZXJ0ZXhOYW1lKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gc3RhcnRpbmdWZXJ0ZXhOYW1lc1xuICAgICAgICB9LCBbXSk7XG5cbiAgcmV0dXJuIHN0YXJ0aW5nVmVydGV4TmFtZXM7XG59XG4iXX0=